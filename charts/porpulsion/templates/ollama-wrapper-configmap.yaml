{{- if .Values.ollama.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "porpulsion.fullname" . }}-ollama-wrapper
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "porpulsion.labels" . | nindent 4 }}
data:
  ollama-wrapper.sh: |
    #!/bin/sh
    # Sources /shared/ollama.env written by porpulsion, then watches for
    # /shared/restart to re-exec ollama serve with updated env.
    ENV_FILE="/shared/ollama.env"
    SENTINEL="/shared/restart"

    start_ollama() {
      if [ -f "$ENV_FILE" ]; then
        set -a
        . "$ENV_FILE"
        set +a
      fi
      rm -f "$SENTINEL"
      ollama serve &
      OLLAMA_PID=$!
      echo "ollama-wrapper: started ollama (pid $OLLAMA_PID)"
    }

    start_ollama

    while true; do
      sleep 2
      if [ -f "$SENTINEL" ]; then
        echo "ollama-wrapper: restart sentinel detected, restarting ollama..."
        kill "$OLLAMA_PID" 2>/dev/null
        wait "$OLLAMA_PID" 2>/dev/null
        start_ollama
      fi
      if ! kill -0 "$OLLAMA_PID" 2>/dev/null; then
        echo "ollama-wrapper: ollama exited unexpectedly, restarting..."
        start_ollama
      fi
    done
{{- end }}
