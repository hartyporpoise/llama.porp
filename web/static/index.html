<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>porpulsion</title>
  <link rel="icon" type="image/png" href="/static/logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
</head>
<body>

  <!-- ── Header ── -->
  <header class="header">
    <div class="header-inner">

      <!-- Left: sidebar toggle + logo -->
      <div class="header-left">
        <button class="btn-ham" id="hamBtn" onclick="toggleSidebar()" title="Toggle history">
          <span></span><span></span><span></span>
        </button>
        <div class="logo-group">
          <img src="/static/logo.png" alt="porpulsion" class="logo" />
          <span class="brand">porpulsion</span>
        </div>
      </div>

      <!-- Right: status only -->
      <div class="header-right">
        <div class="status-dot" id="statusDot" title="Ollama status"></div>
        <span class="tps-badge" id="tpsBadge" title="Tokens per second">— tok/s</span>
      </div>
    </div>
  </header>

  <!-- ── App body: sidebar + chat ── -->
  <div class="app-body">

    <!-- Left sidebar: history + settings button at bottom -->
    <aside class="conv-sidebar" id="convSidebar">
      <div class="conv-sidebar-header">
        <span class="conv-sidebar-title">History</span>
        <button class="btn-icon" onclick="newChat()" title="New chat"
          style="width:26px;height:26px;border-radius:6px;flex-shrink:0">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div class="conv-list" id="convList"></div>
      <!-- Settings button pinned at bottom -->
      <div class="sidebar-footer">
        <button class="btn-settings" onclick="openSettings()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Settings
        </button>
      </div>
    </aside>

    <!-- Main chat area -->
    <main class="main">
      <div class="chat-history" id="chatHistory"></div>
      <div class="chat-input-wrap">
        <textarea id="chatInput" class="chat-input" rows="3"
          placeholder="Send a message…  (Enter to send, Shift+Enter for newline)"
          onkeydown="chatKeydown(event)"></textarea>
        <div class="chat-actions">
          <div class="chat-actions-left">
            <div class="model-picker-wrap">
              <div class="model-picker" id="modelPicker" onclick="toggleModelPicker()">
                <svg class="model-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
                <span class="model-picker-label" id="modelPickerLabel">Loading…</span>
                <svg class="model-picker-chevron" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </div>
              <div class="model-dropdown" id="modelDropdown">
                <div id="modelDropdownList"></div>
              </div>
            </div>
          </div>
          <div class="chat-actions-right">
            <span class="chat-meta" id="chatMeta"></span>
            <!-- Single action button: shows send icon normally, stop icon while streaming -->
            <button class="btn-action" id="actionBtn" onclick="handleActionBtn()" title="Send">
              <!-- Send icon -->
              <svg class="icon-send" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
              <!-- Stop icon -->
              <svg class="icon-stop" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <rect x="4" y="4" width="16" height="16" rx="2"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>

  </div>
  <!-- Tap-to-close overlay for mobile sidebar -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- ── Settings page (full-screen overlay) ── -->
  <div class="settings-page" id="settingsPage">
    <div class="settings-header">
      <button class="settings-back" onclick="closeSettings()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
        </svg>
        Back to chat
      </button>
      <span class="settings-title">Settings</span>
    </div>

    <div class="settings-body">
      <div class="settings-content">

        <!-- Chat parameters -->
        <section class="settings-section">
          <h2 class="settings-section-title">Chat Parameters</h2>

          <div class="field-group">
            <label class="field-label" for="systemPrompt">System prompt</label>
            <textarea id="systemPrompt" class="field-textarea" rows="4"
              placeholder="You are a helpful assistant."></textarea>
          </div>

          <div class="settings-sliders">
            <div class="field-group">
              <label class="field-label">
                Temperature
                <span class="field-value" id="tempVal">0.70</span>
              </label>
              <input type="range" id="temperature" class="field-range"
                min="0" max="2" step="0.05" value="0.7"
                oninput="document.getElementById('tempVal').textContent = parseFloat(this.value).toFixed(2)" />
              <div class="range-hints"><span>Precise</span><span>Creative</span></div>
            </div>

            <div class="field-group">
              <label class="field-label">
                Top-P
                <span class="field-value" id="topPVal">0.90</span>
              </label>
              <input type="range" id="topP" class="field-range"
                min="0" max="1" step="0.01" value="0.9"
                oninput="document.getElementById('topPVal').textContent = parseFloat(this.value).toFixed(2)" />
            </div>

            <div class="field-group">
              <label class="field-label">
                Top-K
                <span class="field-value" id="topKVal">40</span>
              </label>
              <input type="range" id="topK" class="field-range"
                min="1" max="200" step="1" value="40"
                oninput="document.getElementById('topKVal').textContent = this.value" />
            </div>
          </div>

          <div class="settings-numbers">
            <div class="field-group">
              <label class="field-label" for="maxTokens">Max tokens</label>
              <input type="number" id="maxTokens" class="field-input"
                min="1" max="32768" value="2048" placeholder="2048" />
            </div>
            <div class="field-group">
              <label class="field-label" for="ctxSize">Context size</label>
              <input type="number" id="ctxSize" class="field-input"
                min="256" max="131072" step="256" value="4096" placeholder="4096" />
            </div>
            <div class="field-group" style="justify-content:flex-end;align-self:flex-end">
              <button class="btn-reset" onclick="resetConfig()">Reset to defaults</button>
            </div>
          </div>
        </section>

        <!-- Proxy Intelligence -->
        <section class="settings-section">
          <h2 class="settings-section-title">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px">
              <path d="M12 2a8 8 0 0 0-8 8c0 3.4 2.1 6.3 5 7.5V20h6v-2.5c2.9-1.2 5-4.1 5-7.5a8 8 0 0 0-8-8z"/>
              <line x1="9" y1="22" x2="15" y2="22"/>
            </svg>
            Proxy Intelligence
          </h2>
          <p class="field-hint" style="margin-bottom:14px">Application-level features that accelerate inference without modifying Ollama. Semantic Cache auto-pulls nomic-embed-text when enabled.</p>
          <div id="featureListProxy" class="feature-list">
            <span style="font-size:0.78rem;color:var(--text3)">Loading…</span>
          </div>
        </section>

        <!-- Models -->
        <section class="settings-section">
          <h2 class="settings-section-title">Models</h2>
          <div class="field-group">
            <label class="field-label" for="modelSearch">Search &amp; pull models</label>
            <div class="search-wrap">
              <svg class="search-icon" width="13" height="13" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input type="text" id="modelSearch" class="search-input"
                placeholder="llama3.2, phi4, mistral…"
                oninput="onSearchInput()"
                onkeydown="onSearchKeydown(event)" />
              <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display:none">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div id="searchResults" class="search-results" style="display:none"></div>
            <div id="pullProgress" class="pull-progress"></div>
          </div>
          <div id="modelList" class="model-list" style="margin-top:14px"></div>
        </section>

        <!-- Server info -->
        <section class="settings-section">
          <h2 class="settings-section-title">Server Info</h2>
          <div id="infoPanel" class="info-grid">Loading…</div>
        </section>


      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="/static/app.js"></script>
</body>
</html>