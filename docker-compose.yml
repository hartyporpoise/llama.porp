services:
  # ── k3s cluster A ───────────────────────────────────────────
  cluster-a:
    image: rancher/k3s:v1.29.2-k3s1
    command: server --disable traefik --tls-san cluster-a
    privileged: true
    environment:
      - K3S_TOKEN=porpulsion-token
    ports:
      - "6443:6443"    # k8s API
      - "8001:30080"   # NodePort UI
      - "8004:30081"   # NodePort peer server (/peer + /ws)
    networks:
      - porpulsion-net

  # ── k3s cluster B ───────────────────────────────────────────
  cluster-b:
    image: rancher/k3s:v1.29.2-k3s1
    command: server --disable traefik --tls-san cluster-b --https-listen-port 6444
    privileged: true
    environment:
      - K3S_TOKEN=porpulsion-token
    ports:
      - "6444:6444"    # k8s API
      - "8002:30080"   # NodePort UI
      - "8005:30081"   # NodePort peer server (/peer + /ws)
    networks:
      - porpulsion-net

  # ── k3s cluster C ───────────────────────────────────────────
  cluster-c:
    image: rancher/k3s:v1.29.2-k3s1
    command: server --disable traefik --tls-san cluster-c --https-listen-port 6445
    privileged: true
    environment:
      - K3S_TOKEN=porpulsion-token
    ports:
      - "6445:6445"    # k8s API
      - "8003:30080"   # NodePort UI
      - "8006:30081"   # NodePort peer server (/peer + /ws)
    networks:
      - porpulsion-net

  # ── helm runner ─────────────────────────────────────────────
  helm:
    image: alpine/helm:3.14.0
    entrypoint: ["sh", "-c", "apk add --quiet --no-cache docker-cli && sleep infinity"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./charts:/charts
    networks:
      - porpulsion-net
    depends_on:
      - cluster-a
      - cluster-b
      - cluster-c

networks:
  porpulsion-net:
    driver: bridge
