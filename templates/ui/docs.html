{% extends "base.html" %}
{% block title %}Docs{% endblock %}
{% block topbar_title %}Docs{% endblock %}
{% block content %}
<!-- PAGE: Docs (route: /docs) -->
<section id="docs-page" data-page="docs" class="docs-layout">

  <!-- SECTION: RemoteApp Spec -->
  <section id="docs-spec" class="page-section" aria-label="RemoteApp spec reference">
    <div class="card">
      <div class="card-header">
        <h2>RemoteApp Spec</h2>
      </div>
      <div class="card-body">
        <p class="docs-intro">The spec is submitted as YAML in the Deploy form. All fields except <code>image</code> are optional.</p>
        <div class="table-wrap">
          <table class="docs-table">
            <thead>
              <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Default</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><code>image</code></td><td>string</td><td><em>required</em></td><td>Container image reference, e.g. <code>nginx:latest</code></td></tr>
              <tr><td><code>replicas</code></td><td>integer</td><td>1</td><td>Number of pod replicas.</td></tr>
              <tr><td><code>ports</code></td><td>list</td><td>[]</td><td>Ports to expose. Each entry: <code>port</code> (required), <code>name</code> (optional).</td></tr>
              <tr><td><code>resources</code></td><td>object</td><td>—</td><td>Kubernetes resource requests and limits.</td></tr>
              <tr><td><code>command</code></td><td>list</td><td>—</td><td>Override the container ENTRYPOINT.</td></tr>
              <tr><td><code>args</code></td><td>list</td><td>—</td><td>Override the container CMD.</td></tr>
              <tr><td><code>env</code></td><td>list</td><td>—</td><td>Environment variables.</td></tr>
              <tr><td><code>readinessProbe</code></td><td>object</td><td>—</td><td>Probe for when traffic should be sent to the pod.</td></tr>
              <tr><td><code>securityContext</code></td><td>object</td><td>—</td><td>Pod/container security settings.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="docs-section-title">Minimal example</div>
        <div class="docs-code">
          <pre>image: nginx:latest
replicas: 1
ports:
  - port: 80
    name: http</pre>
        </div>
        <div class="docs-section-title">With resources and env vars</div>
        <div class="docs-code">
          <pre>image: myapp:v2.1
replicas: 2
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi
ports:
  - port: 8080
    name: http
  - port: 9090
    name: metrics
env:
  - name: NODE_ENV
    value: production
  - name: API_KEY
    valueFrom:
      secretKeyRef:
        name: my-secret
        key: api-key</pre>
        </div>
        <div class="docs-section-title">Custom entrypoint</div>
        <div class="docs-code">
          <pre>image: python:3.11-slim
command:
  - /bin/sh
  - -c
args:
  - python -m http.server 8000
ports:
  - port: 8000
    name: http</pre>
        </div>
        <div class="docs-section-title">Readiness probe + security hardening</div>
        <div class="docs-code">
          <pre>image: ghcr.io/myorg/api:v3.0
replicas: 2
ports:
  - port: 8080
    name: http
imagePullSecrets:
  - ghcr-credentials
readinessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
securityContext:
  runAsNonRoot: true
  readOnlyRootFilesystem: true</pre>
        </div>
      </div>
    </div>
  </section>

  <!-- SECTION: HTTP API -->
  <section id="docs-api" class="page-section" aria-label="HTTP API reference">
    <div class="card">
      <div class="card-header">
        <h2>HTTP API</h2>
        <a href="/api/openapi.json" target="_blank" rel="noopener" class="btn btn-sm btn-outline">openapi.json</a>
      </div>
      <div class="card-body" id="api-ref-body">
        <div class="loading-placeholder">Loading API reference…</div>
      </div>
    </div>
  </section>

</section>
{% endblock %}
{% block scripts %}
<script>
(function () {
  'use strict';

  var METHOD_COLOR = {
    get:     'method-get',
    post:    'method-post',
    put:     'method-put',
    delete:  'method-delete',
    patch:   'method-patch',
  };

  function esc(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function methodBadge(m) {
    var cls = METHOD_COLOR[m] || 'method-other';
    return '<span class="api-method ' + cls + '">' + m.toUpperCase() + '</span>';
  }

  function statusBadge(code) {
    var cls = code < 300 ? 'status-ok' : code < 400 ? 'status-redir' : 'status-err';
    return '<span class="api-status ' + cls + '">' + esc(code) + '</span>';
  }

  function schemaSnippet(schema, depth) {
    if (!schema) return '';
    depth = depth || 0;
    if (schema['$ref']) {
      var name = schema['$ref'].split('/').pop();
      return '<span class="schema-ref">' + esc(name) + '</span>';
    }
    var type = schema.type || '';
    if (type === 'array') {
      return 'array[' + schemaSnippet(schema.items, depth) + ']';
    }
    if (type === 'object' && schema.properties && depth < 2) {
      var parts = Object.keys(schema.properties).map(function (k) {
        return esc(k) + ': ' + schemaSnippet(schema.properties[k], depth + 1);
      });
      return '{&nbsp;' + parts.join(',&nbsp;') + '&nbsp;}';
    }
    if (schema.enum) {
      return esc(schema.enum.join(' | '));
    }
    return esc(type || 'any');
  }

  function renderParams(params) {
    if (!params || !params.length) return '';
    var rows = params.map(function (p) {
      var required = p.required ? '<span class="param-required">required</span>' : '';
      var loc = '<span class="param-in">' + esc(p.in) + '</span>';
      var schm = p.schema ? schemaSnippet(p.schema) : '';
      return '<tr><td><code>' + esc(p.name) + '</code> ' + required + '</td><td>' + loc + '</td><td class="param-type">' + schm + '</td><td class="param-desc">' + esc(p.description || '') + '</td></tr>';
    });
    return '<table class="api-params-table"><thead><tr><th>Name</th><th>In</th><th>Type</th><th>Description</th></tr></thead><tbody>' + rows.join('') + '</tbody></table>';
  }

  function renderResponses(responses) {
    if (!responses) return '';
    var rows = Object.keys(responses).map(function (code) {
      var r = responses[code];
      var schm = '';
      if (r.content && r.content['application/json'] && r.content['application/json'].schema) {
        schm = '<code class="resp-schema">' + schemaSnippet(r.content['application/json'].schema) + '</code>';
      }
      return '<tr><td>' + statusBadge(parseInt(code)) + '</td><td>' + esc(r.description || '') + '</td><td>' + schm + '</td></tr>';
    });
    return '<table class="api-resp-table"><thead><tr><th>Code</th><th>Description</th><th>Schema</th></tr></thead><tbody>' + rows.join('') + '</tbody></table>';
  }

  function renderRequestBody(rb) {
    if (!rb) return '';
    var schema = rb.content && rb.content['application/json'] && rb.content['application/json'].schema;
    if (!schema) return '';
    var required = rb.required ? ' <span class="param-required">required</span>' : '';
    return '<div class="api-section-label">Request body' + required + '</div>' +
           '<div class="api-body-schema"><code>' + schemaSnippet(schema) + '</code></div>';
  }

  function renderOperation(method, op, path, baseUrl) {
    var id = 'op-' + (op.operationId || (method + path)).replace(/[^a-z0-9]/gi, '-');
    var summary = esc(op.summary || path);
    var desc = op.description ? '<p class="api-op-desc">' + op.description.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') + '</p>' : '';
    var fullPath = (baseUrl || '/api').replace(/\/$/, '') + path;

    var details =
      '<div class="api-op-details">' +
      desc +
      (op.parameters ? renderParams(op.parameters) : '') +
      renderRequestBody(op.requestBody) +
      '<div class="api-section-label">Responses</div>' +
      renderResponses(op.responses) +
      '</div>';

    return '<div class="api-op" id="' + id + '">' +
      '<button type="button" class="api-op-summary" aria-expanded="false" aria-controls="' + id + '-body">' +
        methodBadge(method) +
        '<code class="api-op-path">' + esc(fullPath) + '</code>' +
        '<span class="api-op-title">' + summary + '</span>' +
        '<svg class="api-op-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>' +
      '</button>' +
      '<div class="api-op-body" id="' + id + '-body" hidden>' + details + '</div>' +
    '</div>';
  }

  function groupByTag(paths) {
    var groups = {};
    var order = [];
    Object.keys(paths).forEach(function (path) {
      Object.keys(paths[path]).forEach(function (method) {
        var op = paths[path][method];
        var tag = (op.tags && op.tags[0]) || 'General';
        if (!groups[tag]) { groups[tag] = []; order.push(tag); }
        groups[tag].push({ method: method, path: path, op: op });
      });
    });
    // deduplicate order
    var seen = {};
    order = order.filter(function (t) { return seen[t] ? false : (seen[t] = true); });
    return { groups: groups, order: order };
  }

  function render(spec) {
    var baseUrl = spec.servers && spec.servers[0] && spec.servers[0].url || '/api';
    var grouped = groupByTag(spec.paths || {});
    var html = '';

    grouped.order.forEach(function (tag) {
      html += '<div class="api-tag-group">';
      html += '<div class="api-tag-label">' + esc(tag) + '</div>';
      grouped.groups[tag].forEach(function (item) {
        html += renderOperation(item.method, item.op, item.path, baseUrl);
      });
      html += '</div>';
    });

    var body = document.getElementById('api-ref-body');
    if (body) body.innerHTML = html || '<p class="muted">No endpoints found.</p>';

    // Accordion toggle
    document.querySelectorAll('.api-op-summary').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var expanded = this.getAttribute('aria-expanded') === 'true';
        var bodyEl = document.getElementById(this.getAttribute('aria-controls'));
        this.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        if (bodyEl) bodyEl.hidden = expanded;
        this.classList.toggle('open', !expanded);
      });
    });
  }

  function init() {
    fetch('/api/openapi.json')
      .then(function (r) { return r.json(); })
      .then(render)
      .catch(function (e) {
        var body = document.getElementById('api-ref-body');
        if (body) body.innerHTML = '<p class="muted">Could not load API spec: ' + esc(String(e)) + '</p>';
      });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
{% endblock %}
