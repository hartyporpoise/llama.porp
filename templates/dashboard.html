<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#080b11">
  <title>porpulsion — {{ agent_name }}</title>
  <link rel="icon" type="image/png" href="/static/logo.png">
  <link rel="apple-touch-icon" href="/static/logo.png">
  <style>
    :root {
      --bg: #090c14;
      --surface: #0f1520;
      --surface2: #161d2b;
      --surface3: #1c2536;
      --border: #1e2a3d;
      --border2: #253247;
      --text: #e8edf8;
      --muted: #6e7d99;
      --muted2: #4a5670;
      --accent: #2563eb;
      --accent2: #60a5fa;
      --accent-glow: rgba(37,99,235,0.13);
      --green: #22c55e;
      --green-dim: rgba(34,197,94,0.12);
      --yellow: #f59e0b;
      --yellow-dim: rgba(245,158,11,0.12);
      --red: #ef4444;
      --red-dim: rgba(239,68,68,0.12);
      --blue: #3b82f6;
      --blue-dim: rgba(59,130,246,0.13);
      --purple-dim: rgba(37,99,235,0.13);
      --sidebar-w: 220px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
    }

    /* ── Sidebar ──────────────────────────────────────── */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 10;
    }
    .sidebar-logo {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .sidebar-logo img {
      width: 36px;
      height: 36px;
      object-fit: contain;
      flex-shrink: 0;
      border-radius: 6px;
    }
    .sidebar-logo-wordmark {
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 36px;
    }
    .logo-porp {
      color: var(--accent2);
      background: linear-gradient(90deg, #60a5fa, #93c5fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .logo-ulsion { color: var(--text); }
    .sidebar-agent {
      padding: 0.6rem 1.25rem 0.85rem;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-agent-label { font-size: 0.68rem; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; }
    .sidebar-agent-name  { font-size: 0.82rem; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 6px; }
    .health-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
    .health-dot.red { background: var(--red); }
    nav { padding: 0.6rem 0.5rem; flex: 1; }
    nav a {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--muted);
      text-decoration: none;
      transition: background 0.12s, color 0.12s;
      margin-bottom: 2px;
    }
    nav a .nav-icon { width: 16px; text-align: center; opacity: 0.7; font-size: 0.9rem; }
    nav a:hover { background: var(--surface2); color: var(--text); }
    nav a.active { background: var(--accent-glow); color: var(--accent2); }
    nav a.active .nav-icon { opacity: 1; }
    .nav-badge {
      margin-left: auto;
      background: var(--accent);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 10px;
      line-height: 1.4;
    }
    .sidebar-footer {
      padding: 0.85rem 1.25rem;
      border-top: 1px solid var(--border);
      font-size: 0.72rem;
      color: var(--muted2);
    }

    /* ── Main content ─────────────────────────────────── */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .topbar {
      padding: 0.85rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .topbar-title { font-size: 0.95rem; font-weight: 600; }
    .topbar-meta { font-size: 0.75rem; color: var(--muted); display: flex; align-items: center; gap: 1rem; }
    .content { padding: 1.75rem 2rem; }

    /* ── Page panels ─────────────────────────────────── */
    .page { display: none; }
    .page.active { display: block; }

    /* ── Grid ────────────────────────────────────────── */
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.25rem; }
    .full  { grid-column: 1 / -1; }

    /* ── Cards ───────────────────────────────────────── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .card-header {
      padding: 0.85rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .card-header h2 {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted);
    }
    .card-body { padding: 1.25rem; }
    .card-body.no-pad { padding: 0; }

    /* ── Stat tiles ──────────────────────────────────── */
    .stat-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.1rem 1.25rem;
    }
    .stat-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin-bottom: 0.35rem; }
    .stat-value { font-size: 1.75rem; font-weight: 700; line-height: 1; }
    .stat-sub   { font-size: 0.75rem; color: var(--muted); margin-top: 0.3rem; }
    .stat-value.green  { color: var(--green); }
    .stat-value.accent { color: var(--accent2); }
    .stat-value.yellow { color: var(--yellow); }

    /* ── Tables ──────────────────────────────────────── */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.845rem; }
    th {
      text-align: left;
      padding: 0.55rem 1rem;
      color: var(--muted);
      font-weight: 500;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      background: var(--surface2);
    }
    td {
      padding: 0.65rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface2); }
    .empty-state {
      text-align: center;
      padding: 2.5rem 1rem;
      color: var(--muted2);
      font-size: 0.845rem;
    }
    .empty-icon { font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.4; }

    /* ── Badges ──────────────────────────────────────── */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 5px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .badge-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
    .badge-ready     { background: var(--green-dim);  color: var(--green);  }
    .badge-ready .badge-dot { background: var(--green); }
    .badge-running   { background: var(--blue-dim);   color: var(--blue);   }
    .badge-creating  { background: var(--yellow-dim); color: var(--yellow); }
    .badge-pending   { background: var(--surface3);   color: var(--muted);  }
    .badge-failed    { background: var(--red-dim);    color: var(--red);    }
    .badge-timeout   { background: var(--red-dim);    color: var(--red);    }
    .badge-approved  { background: var(--green-dim);  color: var(--green);  }
    .badge-rejected  { background: var(--red-dim);    color: var(--red);    }
    .badge-deleted   { background: var(--surface3);   color: var(--muted2); }
    .badge-connecting{ background: var(--yellow-dim); color: var(--yellow); }
    .badge-handshake { background: var(--purple-dim); color: var(--accent2);}
    .badge-inbound   { background: var(--blue-dim);   color: var(--blue);   }
    .badge-mtls      { background: var(--green-dim);  color: var(--green);  }

    /* ── Buttons ─────────────────────────────────────── */
    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 7px;
      padding: 0.5rem 1.1rem;
      font-size: 0.845rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.12s, opacity 0.12s;
      font-family: inherit;
    }
    button:hover { background: var(--accent2); }
    .btn-sm {
      padding: 3px 10px;
      font-size: 0.75rem;
      border-radius: 5px;
      background: var(--surface3);
      color: var(--text);
      border: 1px solid var(--border2);
    }
    .btn-sm:hover { background: var(--border2); color: var(--text); }
    .btn-primary { background: var(--purple-dim); color: var(--accent2); border: 1px solid rgba(37,99,235,0.25); }
    .btn-primary:hover { background: var(--accent); color: white; }
    .btn-danger  { background: var(--red-dim); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
    .btn-danger:hover  { background: var(--red); color: white; }
    .btn-success { background: var(--green-dim); color: var(--green); border: 1px solid rgba(34,197,94,0.2); }
    .btn-success:hover { background: var(--green); color: white; }
    .btn-outline { background: transparent; color: var(--muted); border: 1px solid var(--border2); }
    .btn-outline:hover { border-color: var(--accent); color: var(--text); background: transparent; }
    .btn-row { display: flex; gap: 0.5rem; align-items: center; }

    /* ── Forms ───────────────────────────────────────── */
    .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    input, textarea, select {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 7px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 0.845rem;
      width: 100%;
      font-family: inherit;
      -moz-appearance: textfield;
      appearance: textfield;
      transition: border-color 0.12s;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    textarea { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.8rem; resize: vertical; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); }
    input::placeholder, textarea::placeholder { color: var(--muted2); }

    /* ── YAML editor ─────────────────────────────────── */
    .yaml-editor-wrap {
      position: relative;
      background: var(--bg);
      border: 1px solid var(--border2);
      border-radius: 7px;
      overflow: hidden;
      transition: border-color 0.12s;
      display: flex;
      min-height: 160px;
      align-items: stretch;
    }
    .yaml-editor-wrap:focus-within { border-color: var(--accent); }
    .yaml-editor-wrap.is-placeholder { border-color: var(--border); }
    .yaml-linenos {
      padding: 0.55rem 0.5rem 0.55rem 0.6rem;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      line-height: 1.6;
      color: var(--muted2);
      text-align: right;
      user-select: none;
      flex-shrink: 0;
      min-width: 32px;
      border-right: 1px solid var(--border);
      background: var(--surface);
      white-space: pre;
    }
    .yaml-editor-inner {
      position: relative;
      flex: 1;
      min-height: 160px; /* keeps editor open when textarea empties on focus */
    }
    .yaml-highlight {
      position: absolute;
      inset: 0;
      pointer-events: none;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      line-height: 1.6;
      padding: 0.55rem 0.6rem;
      white-space: pre;
      overflow: auto;
      color: transparent; /* text invisible — only coloured spans show */
      z-index: 2; /* sits above textarea so coloured spans render on top */
    }
    .yaml-textarea {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 160px;
      padding: 0.55rem 0.6rem;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      line-height: 1.6;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text); /* visible text; highlight overlay sits on top via z-index */
      caret-color: var(--text);
      resize: none;
      white-space: pre;
      overflow: auto;
      z-index: 1;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .yaml-editor-wrap.is-placeholder .yaml-textarea { caret-color: var(--muted2); }
    /* highlight token colours */
    .yk  { color: var(--accent2); }           /* key */
    .yc  { color: var(--muted2); font-style: italic; } /* comment */
    .ys  { color: var(--green); }             /* string value */
    .yn  { color: var(--yellow); }            /* number value */
    .ybool { color: #f97316; }                /* true/false */
    .yli { color: var(--muted); }             /* list dash */
    .yph { color: var(--muted2); }            /* placeholder text */
    .form-hint { font-size: 0.72rem; color: var(--muted2); margin-top: 0.3rem; }
    .form-row { display: flex; gap: 0.75rem; }
    .form-row .form-group { flex: 1; }

    /* ── Docs page ───────────────────────────────────── */
    .docs-layout { display: flex; flex-direction: column; gap: 1.25rem; }
    .docs-intro { font-size: 0.845rem; color: var(--muted); margin-bottom: 1.1rem; line-height: 1.6; }
    .docs-intro code { background: var(--surface3); padding: 1px 5px; border-radius: 4px; font-size: 0.8rem; color: var(--accent2); font-family: 'SF Mono','Fira Code',monospace; }
    .docs-section-title { font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin: 1.25rem 0 0.6rem; }
    .docs-section-title:first-child { margin-top: 0; }
    .docs-example-label { font-size: 0.78rem; color: var(--muted); margin: 1rem 0 0.35rem; font-weight: 500; }
    .docs-code {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      overflow: auto;
    }
    .docs-code pre {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      line-height: 1.7;
      padding: 0.75rem 1rem;
      white-space: pre;
      margin: 0;
    }
    .docs-table { width: 100%; border-collapse: collapse; font-size: 0.825rem; margin-bottom: 0.25rem; }
    .docs-table th {
      text-align: left; padding: 0.45rem 0.85rem;
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--muted); background: var(--surface2); border-bottom: 1px solid var(--border);
    }
    .docs-table td { padding: 0.55rem 0.85rem; border-bottom: 1px solid var(--border); vertical-align: top; color: var(--text); line-height: 1.5; }
    .docs-table tr:last-child td { border-bottom: none; }
    .docs-table td code { background: var(--surface3); padding: 1px 5px; border-radius: 4px; font-size: 0.77rem; color: var(--accent2); font-family: 'SF Mono','Fira Code',monospace; white-space: nowrap; }
    .docs-table td em { color: var(--red); font-style: normal; font-size: 0.78rem; }
    .api-table-wrap { overflow-x: auto; margin-bottom: 0.5rem; }
    .docs-para { font-size: 0.845rem; color: var(--muted); line-height: 1.65; margin-bottom: 0.75rem; }
    .docs-para strong { color: var(--text); font-weight: 600; }
    .docs-para code { background: var(--surface3); padding: 1px 5px; border-radius: 4px; font-size: 0.8rem; color: var(--accent2); font-family: 'SF Mono','Fira Code',monospace; }
    .method-get  { display:inline-block; padding:1px 7px; border-radius:4px; font-size:0.7rem; font-weight:700; background:var(--blue-dim);   color:var(--blue);   font-family:'SF Mono','Fira Code',monospace; }
    .method-post { display:inline-block; padding:1px 7px; border-radius:4px; font-size:0.7rem; font-weight:700; background:var(--green-dim);  color:var(--green);  font-family:'SF Mono','Fira Code',monospace; }
    .method-put  { display:inline-block; padding:1px 7px; border-radius:4px; font-size:0.7rem; font-weight:700; background:var(--yellow-dim); color:var(--yellow); font-family:'SF Mono','Fira Code',monospace; }
    .method-del  { display:inline-block; padding:1px 7px; border-radius:4px; font-size:0.7rem; font-weight:700; background:var(--red-dim);    color:var(--red);    font-family:'SF Mono','Fira Code',monospace; }

    /* ── Deploy form ─────────────────────────────────── */
    .deploy-form-layout {
      display: grid;
      grid-template-columns: 220px 1fr auto;
      gap: 1.25rem;
      align-items: start;
    }
    .deploy-form-action {
      padding-top: 1.55rem; /* align button with inputs */
    }

    /* ── Segmented control ───────────────────────────── */
    .seg-ctrl {
      display: inline-flex;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 7px;
      padding: 3px;
      gap: 2px;
    }
    .seg-ctrl button {
      background: transparent;
      color: var(--muted);
      border: none;
      border-radius: 5px;
      padding: 0.3rem 0.85rem;
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.12s, color 0.12s;
    }
    .seg-ctrl button:hover { color: var(--text); background: transparent; }
    .seg-ctrl button.active { background: var(--surface3); color: var(--text); }

    /* ── Toggle ──────────────────────────────────────── */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-info .toggle-label { font-size: 0.845rem; font-weight: 500; }
    .toggle-info .toggle-desc  { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .toggle {
      position: relative; display: inline-block;
      width: 38px; height: 21px; flex-shrink: 0; margin-left: 1rem;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; inset: 0;
      background: var(--border2); border-radius: 21px;
      cursor: pointer; transition: background 0.2s;
    }
    .toggle-slider:before {
      content: ''; position: absolute;
      width: 15px; height: 15px; left: 3px; top: 3px;
      background: var(--muted); border-radius: 50%; transition: transform 0.2s, background 0.2s;
    }
    .toggle input:checked + .toggle-slider { background: var(--accent); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(17px); background: white; }

    /* ── Token / code boxes ──────────────────────────── */
    .code-box {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 7px;
      padding: 0.6rem 0.85rem;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      color: var(--accent2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .code-box .code-val { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; word-break: break-all; }
    .code-box.wrap .code-val { white-space: normal; word-break: break-all; }

    /* ── Secret field (masked with eye toggle) ──────── */
    .secret-box {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 7px;
      padding: 0.6rem 0.85rem;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.78rem;
      color: var(--accent2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .secret-box .secret-val {
      flex: 1; overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap; letter-spacing: 0.05em;
    }
    .secret-box .secret-val.masked { letter-spacing: 0.12em; color: var(--muted2); }
    .eye-btn {
      background: none; border: none; padding: 2px 4px; cursor: pointer;
      color: var(--muted2); flex-shrink: 0;
      display: flex; align-items: center; line-height: 1;
    }
    .eye-btn:hover { color: var(--text); background: none; }
    .eye-btn svg { width: 15px; height: 15px; display: block; }

    /* ── Section dividers ────────────────────────────── */
    .section-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted2);
      margin: 1.25rem 0 0.6rem;
    }
    .section-label:first-child { margin-top: 0; }
    .divider { height: 1px; background: var(--border); margin: 1.25rem 0; }

    /* ── Misc ────────────────────────────────────────── */
    .mono { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.78rem; color: var(--muted); }
    .text-muted { color: var(--muted); }
    .text-sm    { font-size: 0.78rem; }
    .time-ago   { color: var(--muted2); font-size: 0.78rem; white-space: nowrap; }
    .flex-end   { display: flex; justify-content: flex-end; }
    .mt1 { margin-top: 0.5rem; }
    .mt2 { margin-top: 1rem; }

    /* ── Quota grid ──────────────────────────────────── */
    .quota-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }

    /* ── Toast ───────────────────────────────────────── */
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem;
      background: var(--surface3);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 0.7rem 1.1rem;
      border-radius: 8px;
      font-size: 0.845rem;
      opacity: 0;
      transition: opacity 0.25s, transform 0.25s;
      transform: translateY(8px);
      pointer-events: none;
      z-index: 300;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      max-width: 320px;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.error { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); color: var(--red); }
    #toast.ok    { background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.25); color: var(--green); }
    #toast.warn  { background: rgba(234,179,8,0.12); border-color: rgba(234,179,8,0.3);  color: var(--yellow); }

    /* ── Modal ───────────────────────────────────────── */
    .modal-backdrop {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 100;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }
    .modal-backdrop.open { display: flex; }
    .modal-inner {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 12px;
      width: min(680px, 94vw);
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .modal-title { font-weight: 600; font-size: 0.95rem; }
    .modal-close {
      background: transparent; color: var(--muted);
      border: none; font-size: 1.1rem; cursor: pointer;
      padding: 2px 6px; line-height: 1; border-radius: 4px;
    }
    .modal-close:hover { color: var(--text); background: var(--surface2); }
    .modal-body { padding: 1.25rem; overflow-y: auto; flex: 1; }

    /* ── Dialog (confirm / prompt) ───────────────────── */
    .dialog-backdrop {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 200;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }
    .dialog-backdrop.open { display: flex; }
    .dialog-inner {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 12px;
      width: min(420px, 92vw);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .dialog-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }
    .dialog-body {
      font-size: 0.845rem;
      color: var(--muted);
      line-height: 1.55;
    }
    .dialog-input {
      width: 100%;
      margin-top: 0.25rem;
    }
    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    /* app detail */
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; margin-bottom: 0.85rem; }
    .detail-block {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.85rem 1rem;
    }
    .detail-block h4 {
      font-size: 0.68rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--muted2); margin: 0 0 0.6rem;
    }
    .detail-row {
      display: flex; justify-content: space-between;
      font-size: 0.82rem; padding: 0.28rem 0;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-row .label { color: var(--muted); }
    .pod-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    .pod-table th { text-align: left; color: var(--muted); font-weight: 500; padding: 0.3rem 0.5rem; border-bottom: 1px solid var(--border); background: var(--surface2); }
    .pod-table td { padding: 0.3rem 0.5rem; border-bottom: 1px solid var(--border); }
    .detail-actions {
      display: flex; gap: 0.5rem; flex-wrap: wrap;
      margin-top: 1rem; padding-top: 1rem;
      border-top: 1px solid var(--border);
      align-items: center;
    }
    .detail-actions label { font-size: 0.78rem; color: var(--muted); }

    /* Inbound banner */
    .inbound-banner {
      background: rgba(59,130,246,0.08);
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
      display: none;
    }
    .inbound-banner.visible { display: block; }
    .inbound-banner-title {
      font-size: 0.78rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.07em;
      color: var(--blue); margin-bottom: 0.6rem;
      display: flex; align-items: center; gap: 6px;
    }
    .pulse { display: inline-block; width: 7px; height: 7px; border-radius: 50%; background: var(--blue); animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.35; } }
    .inbound-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .inbound-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 0.65rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .inbound-item-info { flex: 1; min-width: 0; }
    .inbound-item-name { font-size: 0.845rem; font-weight: 600; }
    .inbound-item-url  { font-size: 0.75rem; color: var(--muted); font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .inbound-item-time { font-size: 0.72rem; color: var(--muted2); white-space: nowrap; }
  </style>
</head>
<body>

<!-- ── Sidebar ───────────────────────────────────────────── -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <img src="/static/logo.png" alt="">
    <span class="sidebar-logo-wordmark"><span class="logo-porp">porp</span><span class="logo-ulsion">ulsion</span></span>
  </div>
  <div class="sidebar-agent">
    <div class="sidebar-agent-label">Agent</div>
    <div class="sidebar-agent-name">
      <span class="health-dot" id="health-dot"></span>
      {{ agent_name }}
    </div>
  </div>
  <nav id="nav">
    <a href="#" data-page="page-overview" class="active">
      <span class="nav-icon">◈</span> Overview
    </a>
    <a href="#" data-page="page-peers">
      <span class="nav-icon">⇄</span> Peers
      <span class="nav-badge" id="nav-inbound-badge" style="display:none">!</span>
    </a>
    <a href="#" data-page="page-workloads">
      <span class="nav-icon">⬡</span> Workloads
    </a>
    <a href="#" data-page="page-tunnels">
      <span class="nav-icon">⇒</span> Proxy
    </a>
    <a href="#" data-page="page-settings">
      <span class="nav-icon">⚙</span> Settings
    </a>
    <a href="#" data-page="page-docs">
      <span class="nav-icon">◎</span> Docs
    </a>
  </nav>
  <div class="sidebar-footer">
    <div>Updated <span id="last-refresh">—</span></div>
  </div>
</aside>

<!-- ── Main ──────────────────────────────────────────────── -->
<main class="main">
  <div class="topbar">
    <span class="topbar-title" id="topbar-title">Overview</span>
    <div class="topbar-meta">
      <span id="peer-count-label">0 peers</span>
    </div>
  </div>

  <div class="content">

    <!-- ══════════════════ OVERVIEW ══════════════════ -->
    <div class="page active" id="page-overview">
      <div class="grid3" style="margin-bottom:1.25rem;">
        <div class="stat-tile">
          <div class="stat-label">Connected Peers</div>
          <div class="stat-value green" id="stat-peers">0</div>
          <div class="stat-sub" id="stat-peers-sub">no peers</div>
        </div>
        <div class="stat-tile">
          <div class="stat-label">Submitted Apps</div>
          <div class="stat-value accent" id="stat-submitted">0</div>
          <div class="stat-sub">running on peers</div>
        </div>
        <div class="stat-tile">
          <div class="stat-label">Executing Apps</div>
          <div class="stat-value accent" id="stat-executing">0</div>
          <div class="stat-sub">from peers, on this cluster</div>
        </div>
      </div>

      <div class="grid2" style="margin-bottom:1.25rem;">
        <div class="card">
          <div class="card-header">
            <h2>Connected Peers</h2>
            <span class="badge badge-mtls" id="peers-count-badge">0</span>
          </div>
          <div class="card-body no-pad">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>URL</th><th>Since</th></tr></thead>
                <tbody id="overview-peers-body"></tbody>
              </table>
            </div>
            <div class="empty-state" id="overview-peers-empty">
              <div class="empty-icon">⇄</div>No peers connected
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Recent Apps</h2>
            <span class="badge badge-pending" id="recent-apps-count">0</span>
          </div>
          <div class="card-body no-pad">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>Type</th><th>Status</th><th>Updated</th><th></th></tr></thead>
                <tbody id="recent-apps-body"></tbody>
              </table>
            </div>
            <div class="empty-state" id="recent-apps-empty">
              <div class="empty-icon">⬡</div>No apps yet
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Deploy RemoteApp</h2></div>
        <div class="card-body">
          <form id="deploy-form">
            <div class="deploy-form-layout">
              <div class="form-group">
                <label class="form-label">App name</label>
                <input type="text" id="app-name" placeholder="e.g. my-nginx" required>
              </div>
              <div class="form-group" style="flex:1;">
                <label class="form-label">Spec (YAML)</label>
                <div class="yaml-editor-wrap is-placeholder" id="deploy-editor-wrap">
                  <div class="yaml-linenos" id="deploy-editor-linenos">1</div>
                  <div class="yaml-editor-inner">
                    <div class="yaml-highlight" id="deploy-editor-hl" aria-hidden="true"></div>
                    <textarea class="yaml-textarea" id="app-spec-yaml" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
                  </div>
                </div>
                <span class="form-hint">Clear the editor to restore the example. Tab inserts 2 spaces.</span>
              </div>
              <div class="deploy-form-action">
                <button type="submit">Deploy to Peer</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ══════════════════ PEERS ══════════════════════ -->
    <div class="page" id="page-peers">

      <!-- Inbound requests banner -->
      <div class="inbound-banner" id="inbound-banner">
        <div class="inbound-banner-title">
          <span class="pulse"></span> Incoming Connection Requests
        </div>
        <div class="inbound-list" id="inbound-list"></div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="card-header"><h2>Connect a New Peer</h2></div>
          <div class="card-body">
            <form id="connect-peer-form">
              <div class="form-group">
                <label class="form-label">Peer mTLS URL</label>
                <input type="text" id="new-peer-url" placeholder="https://192.168.1.100:30443">
              </div>
              <div class="form-group">
                <label class="form-label">Their invite token</label>
                <input type="text" id="new-peer-token" placeholder="paste their invite token here" autocomplete="off">
              </div>
              <div class="form-group">
                <label class="form-label">Their CA fingerprint (SHA-256)</label>
                <input type="text" id="new-peer-fp" placeholder="paste their CA fingerprint here" autocomplete="off" style="font-family:monospace;font-size:0.75rem;">
                <span class="form-hint">Prevents MITM during bootstrap. Get this from their Settings → Connection Info page.</span>
              </div>
              <div class="flex-end mt1">
                <button type="submit">Initiate Peering</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h2>Connect Credentials</h2></div>
          <div class="card-body">
            <p class="text-sm text-muted" style="margin-bottom:1rem;">
              Share your endpoint URL, invite token, and CA fingerprint with the peer who wants to connect to you. The token is single-use and rotates automatically after use.
            </p>
            <div class="section-label">mTLS endpoint URL</div>
            <div class="code-box">
              <span class="code-val" id="token-url">loading…</span>
              <button class="btn-sm" onclick="copyText('token-url', this)">Copy</button>
            </div>
            <div class="section-label" style="margin-top:1rem;">Invite token (single-use)</div>
            <div class="secret-box">
              <span class="secret-val masked" id="token-key" data-value="">••••••••••••••••••••••••••••••••</span>
              <button class="eye-btn" onclick="toggleSecret('token-key', this)" title="Show/hide"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/><circle cx="10" cy="10" r="2.5"/></svg></button>
              <button class="btn-sm" onclick="copySecret('token-key', this)">Copy</button>
            </div>
            <div class="section-label" style="margin-top:1rem;">CA fingerprint (SHA-256)</div>
            <div class="secret-box">
              <span class="secret-val masked" id="token-fp-peers" data-value="" style="font-size:0.68rem;">••••••••••••••••••••••••••••••••••••••••••••••••</span>
              <button class="eye-btn" onclick="toggleSecret('token-fp-peers', this)" title="Show/hide"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/><circle cx="10" cy="10" r="2.5"/></svg></button>
              <button class="btn-sm" onclick="copySecret('token-fp-peers', this)">Copy</button>
            </div>
          </div>
        </div>

        <div class="card full">
          <div class="card-header">
            <h2>All Peers</h2>
            <span class="badge badge-pending" id="all-peers-count">0</span>
          </div>
          <div class="card-body no-pad">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>URL</th><th>mTLS</th><th>Connected</th><th></th></tr></thead>
                <tbody id="all-peers-body"></tbody>
              </table>
            </div>
            <div class="empty-state" id="all-peers-empty">
              <div class="empty-icon">⇄</div>No peers yet
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ══════════════════ WORKLOADS ══════════════════ -->
    <div class="page" id="page-workloads">
      <div style="margin-bottom:1.25rem;">
        <div class="card">
          <div class="card-header">
            <h2>Submitted Apps <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted2);font-size:0.72rem;">— deployed by you, running on peers</span></h2>
            <span class="badge badge-pending" id="submitted-count">0</span>
          </div>
          <div class="card-body no-pad">
            <div class="table-wrap">
              <table>
                <thead><tr><th>Name</th><th>ID</th><th>Status</th><th>Running on</th><th>Updated</th><th></th></tr></thead>
                <tbody id="submitted-body"></tbody>
              </table>
            </div>
            <div class="empty-state" id="submitted-empty">
              <div class="empty-icon">⬡</div>No apps submitted yet — deploy one from the Overview page
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Executing Apps <span style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted2);font-size:0.72rem;">— received from peers, running here</span></h2>
          <span class="badge badge-pending" id="executing-count">0</span>
        </div>
        <div class="card-body no-pad">
          <div class="table-wrap">
            <table>
              <thead><tr><th>Name</th><th>ID</th><th>Status</th><th>From Peer</th><th>Updated</th><th></th></tr></thead>
              <tbody id="executing-body"></tbody>
            </table>
          </div>
          <div class="empty-state" id="executing-empty">
            <div class="empty-icon">⬡</div>No apps received from peers
          </div>
        </div>
      </div>
    </div>

    <!-- ══════════════════ PROXY / TUNNELS ════════════ -->
    <div class="page" id="page-tunnels">
      <div class="card">
        <div class="card-header"><h2>HTTP Proxy</h2></div>
        <div class="card-body">
          <p class="text-sm text-muted" style="margin-bottom:1rem;">
            Each RemoteApp port is accessible via a built-in HTTP proxy route — no tunnel setup required.
            Requests are forwarded over mTLS to the executing peer and proxied directly to the pod.
          </p>
          <div class="section-label">Proxy URL format</div>
          <div class="code-box" style="margin-bottom:1rem;">
            <span class="code-val" style="color:var(--muted);">{this-agent-url}<strong style="color:var(--accent2);">/remoteapp/&lt;app-id&gt;/proxy/&lt;port&gt;/&lt;path&gt;</strong></span>
          </div>
          <p class="text-sm text-muted" style="margin-bottom:1.25rem;">
            Open the <strong style="color:var(--text);">Detail</strong> view for any submitted app to get ready-to-use proxy URLs for each configured port.
          </p>
          <div class="card" style="background:var(--surface2);border-color:var(--border2);">
            <div class="card-body">
              <div class="section-label" style="margin-top:0;">Submitted Apps with Proxy Access</div>
              <div id="proxy-apps-list" style="margin-top:0.75rem;">
                <div class="empty-state" style="padding:1.5rem 0.5rem;">
                  <div class="empty-icon">⇒</div>No submitted apps yet
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ══════════════════ SETTINGS ═══════════════════ -->
    <div class="page" id="page-settings">
      <div class="grid2">

        <div class="card">
          <div class="card-header"><h2>Connect Credentials</h2></div>
          <div class="card-body">
            <div class="section-label">mTLS endpoint URL</div>
            <div class="code-box">
              <span class="code-val" id="settings-token-url">loading…</span>
              <button class="btn-sm" onclick="copyText('settings-token-url', this)">Copy</button>
            </div>
            <div class="section-label" style="margin-top:1rem;">Invite token (single-use)</div>
            <div class="secret-box">
              <span class="secret-val masked" id="settings-token-key" data-value="">••••••••••••••••••••••••••••••••</span>
              <button class="eye-btn" onclick="toggleSecret('settings-token-key', this)" title="Show/hide"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/><circle cx="10" cy="10" r="2.5"/></svg></button>
              <button class="btn-sm" onclick="copySecret('settings-token-key', this)">Copy</button>
            </div>
            <div class="section-label" style="margin-top:1rem;">CA fingerprint (SHA-256)</div>
            <div class="secret-box">
              <span class="secret-val masked" id="token-fp" data-value="" style="font-size:0.68rem;">••••••••••••••••••••••••••••••••••••••••••••••••</span>
              <button class="eye-btn" onclick="toggleSecret('token-fp', this)" title="Show/hide"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/><circle cx="10" cy="10" r="2.5"/></svg></button>
              <button class="btn-sm" onclick="copySecret('token-fp', this)">Copy</button>
            </div>
            <div class="section-label" style="margin-top:1rem;">CA certificate (PEM)</div>
            <textarea id="token-pem" rows="5" readonly style="font-size:0.7rem; color:var(--muted);">loading…</textarea>
            <div class="flex-end mt1">
              <button class="btn-sm btn-outline" onclick="copyText('token-pem', this)">Copy PEM</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h2>About this Agent</h2></div>
          <div class="card-body">
            <div class="toggle-row">
              <div class="toggle-info"><div class="toggle-label">Agent name</div></div>
              <span class="mono">{{ agent_name }}</span>
            </div>
            <div class="toggle-row">
              <div class="toggle-info"><div class="toggle-label">mTLS endpoint</div></div>
              <span class="mono text-sm" id="about-url">—</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h2>Access Control</h2></div>
          <div class="card-body">
            <div class="toggle-row">
              <div class="toggle-info">
                <div class="toggle-label">Accept inbound workloads</div>
                <div class="toggle-desc">Allow peers to deploy RemoteApps on this cluster</div>
              </div>
              <label class="toggle">
                <input type="checkbox" id="setting-inbound-apps" onchange="saveSetting('allow_inbound_remoteapps', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>


        <div class="card">
          <div class="card-header"><h2>Diagnostics</h2></div>
          <div class="card-body">
            <div class="section-label">Log level</div>
            <div class="seg-ctrl" id="setting-log-level">
              <button data-val="DEBUG"   onclick="setSegVal('setting-log-level',this);saveSetting('log_level','DEBUG')">Debug</button>
              <button data-val="INFO" class="active" onclick="setSegVal('setting-log-level',this);saveSetting('log_level','INFO')">Info</button>
              <button data-val="WARNING" onclick="setSegVal('setting-log-level',this);saveSetting('log_level','WARNING')">Warn</button>
              <button data-val="ERROR"   onclick="setSegVal('setting-log-level',this);saveSetting('log_level','ERROR')">Error</button>
            </div>
          </div>
        </div>

        <div class="card full">
          <div class="card-header"><h2>Resource Quotas</h2></div>
          <div class="card-body">
            <p class="text-sm text-muted" style="margin-bottom:1rem;">
              Enforced on <strong style="color:var(--text);">inbound</strong> RemoteApp workloads. Set to <strong style="color:var(--text);">0</strong> for unlimited.
            </p>
            <div class="section-label">Per-pod limits</div>
            <div class="quota-grid" style="margin-bottom:1rem;">
              <div class="form-group">
                <label class="form-label">Max CPU per pod (cores)</label>
                <input type="text" inputmode="decimal" id="quota-cpu-pod" placeholder="0 = unlimited">
              </div>
              <div class="form-group">
                <label class="form-label">Max memory per pod (MiB)</label>
                <input type="text" inputmode="numeric" id="quota-mem-pod" placeholder="0 = unlimited">
              </div>
              <div class="form-group">
                <label class="form-label">Max replicas per app</label>
                <input type="text" inputmode="numeric" id="quota-replicas" placeholder="0 = unlimited">
              </div>
            </div>
            <div class="section-label">Aggregate limits</div>
            <div class="quota-grid" style="margin-bottom:1rem;">
              <div class="form-group">
                <label class="form-label">Max concurrent deployments</label>
                <input type="text" inputmode="numeric" id="quota-total-deploys" placeholder="0 = unlimited">
              </div>
              <div class="form-group">
                <label class="form-label">Max total CPU (cores)</label>
                <input type="text" inputmode="decimal" id="quota-total-cpu" placeholder="0 = unlimited">
              </div>
              <div class="form-group">
                <label class="form-label">Max total memory (MiB)</label>
                <input type="text" inputmode="numeric" id="quota-total-mem" placeholder="0 = unlimited">
              </div>
            </div>
            <button onclick="saveQuotas()">Save Quotas</button>
          </div>
        </div>

      </div>
    </div>

    <!-- ══════════════════ DOCS ══════════════════════ -->
    <div class="page" id="page-docs">
      <div class="docs-layout">

        <!-- ── Spec reference ── -->
        <div class="card">
          <div class="card-header"><h2>RemoteApp Spec</h2></div>
          <div class="card-body">
            <p class="docs-intro">The spec is submitted as YAML in the Deploy form. All fields except <code>image</code> are optional.</p>
            <table class="docs-table">
              <thead><tr><th>Field</th><th>Type</th><th>Default</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>image</code></td><td>string</td><td><em>required</em></td><td>Container image reference, e.g. <code>nginx:latest</code> or <code>ghcr.io/org/app:v1.2</code></td></tr>
                <tr><td><code>replicas</code></td><td>integer</td><td>1</td><td>Number of pod replicas. Subject to peer quota limits.</td></tr>
                <tr><td><code>ports</code></td><td>list</td><td>[]</td><td>Ports to expose via the HTTP proxy. Each entry: <code>port</code> (required), <code>name</code> (optional label).</td></tr>
                <tr><td><code>cpu</code></td><td>float</td><td>—</td><td>CPU request/limit in cores, e.g. <code>0.5</code>. Checked against peer quota.</td></tr>
                <tr><td><code>memory_mb</code></td><td>integer</td><td>—</td><td>Memory request/limit in MiB, e.g. <code>256</code>. Checked against peer quota.</td></tr>
                <tr><td><code>env</code></td><td>map</td><td>{}</td><td>Environment variables injected into the pod, e.g. <code>ENV: production</code>.</td></tr>
                <tr><td><code>command</code></td><td>list/string</td><td>—</td><td>Override the container entrypoint.</td></tr>
                <tr><td><code>args</code></td><td>list/string</td><td>—</td><td>Arguments passed to the entrypoint.</td></tr>
              </tbody>
            </table>

            <div class="docs-section-title">Examples</div>

            <div class="docs-example-label">Minimal — nginx serving on port 80</div>
            <div class="docs-code"><pre><span class="yk">image</span>: <span class="ys">nginx:latest</span>
<span class="yk">replicas</span>: <span class="yn">1</span>
<span class="yk">ports</span>:
  <span class="yli">- </span><span class="yk">port</span>: <span class="yn">80</span>
    <span class="yk">name</span>: <span class="ys">http</span></pre></div>

            <div class="docs-example-label">With resources and env vars</div>
            <div class="docs-code"><pre><span class="yk">image</span>: <span class="ys">myapp:v2.1</span>
<span class="yk">replicas</span>: <span class="yn">2</span>
<span class="yk">cpu</span>: <span class="yn">0.5</span>
<span class="yk">memory_mb</span>: <span class="yn">512</span>
<span class="yk">ports</span>:
  <span class="yli">- </span><span class="yk">port</span>: <span class="yn">8080</span>
    <span class="yk">name</span>: <span class="ys">http</span>
  <span class="yli">- </span><span class="yk">port</span>: <span class="yn">9090</span>
    <span class="yk">name</span>: <span class="ys">metrics</span>
<span class="yk">env</span>:
  <span class="yk">NODE_ENV</span>: <span class="ys">production</span>
  <span class="yk">LOG_LEVEL</span>: <span class="ys">info</span></pre></div>

            <div class="docs-example-label">Custom entrypoint</div>
            <div class="docs-code"><pre><span class="yk">image</span>: <span class="ys">python:3.11-slim</span>
<span class="yk">command</span>: <span class="ys">python</span>
<span class="yk">args</span>: <span class="ys">-m http.server 8000</span>
<span class="yk">ports</span>:
  <span class="yli">- </span><span class="yk">port</span>: <span class="yn">8000</span>
    <span class="yk">name</span>: <span class="ys">http</span></pre></div>
          </div>
        </div>

        <!-- ── API reference ── -->
        <div class="card">
          <div class="card-header"><h2>HTTP API</h2></div>
          <div class="card-body">
            <p class="docs-intro">All endpoints are served on port <code>8000</code>. Peer-to-peer calls use mTLS on port <code>8443</code>.</p>

            <div class="docs-section-title">Peering</div>
            <div class="api-table-wrap">
              <table class="docs-table">
                <thead><tr><th>Method</th><th>Path</th><th>Description</th></tr></thead>
                <tbody>
                  <tr><td><span class="method-get">GET</span></td><td><code>/token</code></td><td>Returns the one-time invite token, self URL, and CA fingerprint.</td></tr>
                  <tr><td><span class="method-post">POST</span></td><td><code>/peer</code></td><td>Peering handshake endpoint. Used by the initiating agent.</td></tr>
                  <tr><td><span class="method-post">POST</span></td><td><code>/peers/connect</code></td><td>Initiate a peer connection. Body: <code>{"url","invite_token","ca_fingerprint"}</code></td></tr>
                  <tr><td><span class="method-get">GET</span></td><td><code>/peers</code></td><td>List all connected and pending peers.</td></tr>
                  <tr><td><span class="method-del">DELETE</span></td><td><code>/peers/{name}</code></td><td>Remove a peer and disconnect.</td></tr>
                  <tr><td><span class="method-get">GET</span></td><td><code>/peers/inbound</code></td><td>List pending inbound connection requests.</td></tr>
                  <tr><td><span class="method-post">POST</span></td><td><code>/peers/inbound/{id}/accept</code></td><td>Accept an inbound peering request.</td></tr>
                  <tr><td><span class="method-del">DELETE</span></td><td><code>/peers/inbound/{id}</code></td><td>Reject an inbound peering request.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="docs-section-title">RemoteApps</div>
            <div class="api-table-wrap">
              <table class="docs-table">
                <thead><tr><th>Method</th><th>Path</th><th>Description</th></tr></thead>
                <tbody>
                  <tr><td><span class="method-post">POST</span></td><td><code>/remoteapp</code></td><td>Submit a new app to a peer. Body: <code>{"name","spec":{}}</code></td></tr>
                  <tr><td><span class="method-get">GET</span></td><td><code>/remoteapps</code></td><td>List all submitted and executing apps.</td></tr>
                  <tr><td><span class="method-get">GET</span></td><td><code>/remoteapp/{id}/detail</code></td><td>Get k8s deployment detail for an app.</td></tr>
                  <tr><td><span class="method-put">PUT</span></td><td><code>/remoteapp/{id}/spec</code></td><td>Update app spec (triggers re-deploy on peer).</td></tr>
                  <tr><td><span class="method-post">POST</span></td><td><code>/remoteapp/{id}/scale</code></td><td>Scale replicas. Body: <code>{"replicas": N}</code></td></tr>
                  <tr><td><span class="method-del">DELETE</span></td><td><code>/remoteapp/{id}</code></td><td>Delete app and clean up peer workloads.</td></tr>
                  <tr><td><span class="method-get">GET</span></td><td><code>/remoteapp/{id}/proxy/{port}/{path}</code></td><td>HTTP reverse proxy to the app's pod on the peer cluster.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="docs-section-title">Settings</div>
            <div class="api-table-wrap">
              <table class="docs-table">
                <thead><tr><th>Method</th><th>Path</th><th>Description</th></tr></thead>
                <tbody>
                  <tr><td><span class="method-get">GET</span></td><td><code>/settings</code></td><td>Get current agent settings.</td></tr>
                  <tr><td><span class="method-post">POST</span></td><td><code>/settings</code></td><td>Update settings. See fields below.</td></tr>
                  <tr><td><span class="method-get">GET</span></td><td><code>/status</code></td><td>Agent health: name, peer count, app counts.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="docs-section-title">Settings fields</div>
            <table class="docs-table">
              <thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>allow_inbound_remoteapps</code></td><td>boolean</td><td>Accept RemoteApp workloads from peers.</td></tr>
                <tr><td><code>log_level</code></td><td>string</td><td>DEBUG / INFO / WARNING / ERROR</td></tr>
                <tr><td><code>max_cpu_per_pod</code></td><td>float</td><td>Max CPU cores per submitted app. 0 = unlimited.</td></tr>
                <tr><td><code>max_memory_mb_per_pod</code></td><td>integer</td><td>Max memory per app in MiB. 0 = unlimited.</td></tr>
                <tr><td><code>max_replicas_per_app</code></td><td>integer</td><td>Max replicas per app. 0 = unlimited.</td></tr>
                <tr><td><code>max_total_deployments</code></td><td>integer</td><td>Max concurrent executing apps. 0 = unlimited.</td></tr>
                <tr><td><code>max_total_cpu</code></td><td>float</td><td>Max total CPU across all apps. 0 = unlimited.</td></tr>
                <tr><td><code>max_total_memory_mb</code></td><td>integer</td><td>Max total memory across all apps in MiB. 0 = unlimited.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ── Quick start ── -->
        <div class="card">
          <div class="card-header"><h2>Quick Start</h2></div>
          <div class="card-body">
            <div class="docs-section-title">1 · Peer two clusters</div>
            <p class="docs-para">On <strong>Cluster A</strong>, open the Peers page and copy the invite token + CA fingerprint. On <strong>Cluster B</strong>, paste them into the Connect form. Cluster B will appear connected on both sides.</p>

            <div class="docs-section-title">2 · Deploy a RemoteApp</div>
            <p class="docs-para">On Cluster A's Overview page, fill in an app name and spec YAML, then click <strong>Deploy to Peer</strong>. The spec is forwarded to Cluster B which creates a Kubernetes Deployment in the <code>porpulsion</code> namespace.</p>

            <div class="docs-section-title">3 · Access via proxy</div>
            <p class="docs-para">Navigate to the <strong>Proxy</strong> page to see all submitted apps with per-port proxy URLs. Click a URL to open the app through the mTLS tunnel — no extra port exposure needed.</p>

            <div class="docs-section-title">Helm install</div>
            <div class="docs-code"><pre><span class="yc"># Add the chart (ClusterIP default — put your own ingress on top)</span>
helm upgrade --install porpulsion oci://ghcr.io/hartyporpoise/porpulsion \
  --create-namespace --namespace porpulsion \
  --set agent.agentName=my-cluster \
  --set agent.selfUrl=https://agent.example.com:8443

<span class="yc"># NodePort for local dev</span>
helm upgrade --install porpulsion ./chart/porpulsion \
  --set service.type=NodePort \
  --set service.uiNodePort=30080 \
  --set service.agentNodePort=30443</pre></div>
          </div>
        </div>

      </div>
    </div>

  </div><!-- /content -->
</main>

<!-- ── App detail modal ──────────────────────────────────── -->
<div class="modal-backdrop" id="app-modal">
  <div class="modal-inner" style="width:min(780px,96vw);">
    <div class="modal-header">
      <span class="modal-title" id="app-modal-title">App Detail</span>
      <button class="modal-close" onclick="closeAppModal()">✕</button>
    </div>
    <div class="modal-body" id="app-modal-body">
      <p class="text-muted text-sm">Loading…</p>
    </div>
  </div>
</div>

<!-- ── Dialog (confirm / prompt) ──────────────────────────── -->
<div class="dialog-backdrop" id="dialog-backdrop">
  <div class="dialog-inner">
    <div class="dialog-title" id="dialog-title"></div>
    <div class="dialog-body" id="dialog-body"></div>
    <input class="dialog-input" type="text" id="dialog-input" style="display:none;" autocomplete="off" spellcheck="false">
    <div class="dialog-actions" id="dialog-actions"></div>
  </div>
</div>

<div id="toast"></div>

<script>
// ════════════════════════════════════════════════════════════
//  Navigation
// ════════════════════════════════════════════════════════════

var PAGE_TITLES = {
  'page-overview':  'Overview',
  'page-peers':     'Peers',
  'page-workloads': 'Workloads',
  'page-tunnels':   'Proxy',
  'page-settings':  'Settings',
  'page-docs':      'Docs',
};

document.querySelectorAll('nav a').forEach(function(link) {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    document.querySelectorAll('nav a').forEach(function(l) { l.classList.remove('active'); });
    document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
    link.classList.add('active');
    var target = document.getElementById(link.dataset.page);
    if (target) target.classList.add('active');
    document.getElementById('topbar-title').textContent = PAGE_TITLES[link.dataset.page] || '';
  });
});

// ════════════════════════════════════════════════════════════
//  Utilities
// ════════════════════════════════════════════════════════════

// HTML-escape for safe use in attribute values and text content
function _esc(s) {
  return String(s || '')
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Delegated click handler for app and peer tables (avoids inline onclick quoting issues)
document.addEventListener('click', function(e) {
  var btn = e.target.closest('button, a');
  if (!btn) return;

  // App rows
  var appRow = btn.closest('tr[data-app-id]');
  if (appRow) {
    var id   = appRow.dataset.appId;
    var name = appRow.dataset.appName;
    if (btn.classList.contains('app-open-link') || btn.classList.contains('app-detail-btn')) {
      e.preventDefault();
      openAppModal(id);
    } else if (btn.classList.contains('app-delete-btn')) {
      e.preventDefault();
      deleteApp(id, name);
    }
    return;
  }

  // Peer rows
  var peerRow = btn.closest('tr[data-peer-url]');
  if (peerRow) {
    var url  = peerRow.dataset.peerUrl;
    var pname = peerRow.dataset.peerName;
    if (btn.classList.contains('peer-cancel-btn')) {
      e.preventDefault();
      cancelConnecting(url);
    } else if (btn.classList.contains('peer-retry-btn')) {
      e.preventDefault();
      retryConnecting(url);
    } else if (btn.classList.contains('peer-remove-btn')) {
      e.preventDefault();
      removePeer(pname);
    }
    return;
  }
});

function statusBadge(status) {
  var s = (status || 'unknown').toLowerCase();
  var cls = 'badge-pending';
  var dot = '';
  if      (s === 'ready')        { cls = 'badge-ready';    dot = '<span class="badge-dot"></span>'; }
  else if (s === 'running')      { cls = 'badge-running'; }
  else if (s === 'creating')     { cls = 'badge-creating'; }
  else if (s.startsWith('fail')) { cls = 'badge-failed'; }
  else if (s === 'timeout')      { cls = 'badge-timeout'; }
  else if (s === 'approved')     { cls = 'badge-approved'; }
  else if (s === 'rejected')     { cls = 'badge-rejected'; }
  else if (s === 'deleted')      { cls = 'badge-deleted'; }
  return '<span class="badge ' + cls + '">' + dot + (status || 'unknown') + '</span>';
}

function timeAgo(iso) {
  if (!iso) return '';
  var diff = (Date.now() - new Date(iso).getTime()) / 1000;
  if (diff < 60)   return Math.floor(diff) + 's ago';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  return Math.floor(diff / 3600) + 'h ago';
}

function toast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show' + (type === 'error' ? ' error' : type === 'ok' ? ' ok' : type === 'warn' ? ' warn' : '');
  clearTimeout(t._timer);
  t._timer = setTimeout(function() { t.className = ''; }, 3000);
}

// ════════════════════════════════════════════════════════════
//  Dialog (confirm / prompt) — no native browser popups
// ════════════════════════════════════════════════════════════

var _dialogResolve = null;

function _openDialog(title, body, hasInput, inputPlaceholder, confirmLabel, confirmClass) {
  return new Promise(function(resolve) {
    _dialogResolve = resolve;
    document.getElementById('dialog-title').textContent = title;
    document.getElementById('dialog-body').textContent  = body;
    var inp = document.getElementById('dialog-input');
    if (hasInput) {
      inp.style.display = '';
      inp.placeholder   = inputPlaceholder || '';
      inp.value         = '';
    } else {
      inp.style.display = 'none';
    }
    var actions = document.getElementById('dialog-actions');
    var cls = confirmClass || 'btn-danger';
    actions.innerHTML =
      '<button class="btn-sm btn-outline" id="dialog-cancel">Cancel</button>'
      + '<button class="btn-sm ' + cls + '" id="dialog-confirm">' + (confirmLabel || 'Confirm') + '</button>';
    document.getElementById('dialog-cancel').addEventListener('click', function() { _closeDialog(null); });
    document.getElementById('dialog-confirm').addEventListener('click', function() {
      _closeDialog(hasInput ? document.getElementById('dialog-input').value : true);
    });
    if (hasInput) {
      // Submit on Enter
      inp.onkeydown = function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          _closeDialog(inp.value);
        }
        if (e.key === 'Escape') _closeDialog(null);
      };
    }
    document.getElementById('dialog-backdrop').classList.add('open');
    if (hasInput) setTimeout(function() { inp.focus(); }, 50);
  });
}

function _closeDialog(value) {
  document.getElementById('dialog-backdrop').classList.remove('open');
  if (_dialogResolve) { _dialogResolve(value); _dialogResolve = null; }
}

// Dismiss on backdrop click
document.getElementById('dialog-backdrop').addEventListener('click', function(e) {
  if (e.target === this) _closeDialog(null);
});

// showConfirm(title, body, confirmLabel?) → Promise<true|null>
function showConfirm(title, body, confirmLabel, confirmClass) {
  return _openDialog(title, body, false, '', confirmLabel || 'Confirm', confirmClass || 'btn-danger');
}

// showPrompt(title, body, placeholder?) → Promise<string|null>
function showPrompt(title, body, placeholder) {
  return _openDialog(title, body, true, placeholder || '', 'Submit', 'btn-primary');
}

function copyText(elemId, btn) {
  var el = document.getElementById(elemId);
  var text = (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') ? el.value : el.textContent;
  navigator.clipboard.writeText(text.trim()).then(function() {
    var orig = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.textContent = orig; }, 1500);
  }).catch(function() { toast('Copy failed', 'error'); });
}

// ════════════════════════════════════════════════════════════
//  YAML helpers
// ════════════════════════════════════════════════════════════

function parseSimpleYaml(text) {
  var result = {};
  var lines = text.split('\n');
  var i = 0;
  while (i < lines.length) {
    var line = lines[i];
    var trimmed = line.trim();
    if (!trimmed || trimmed.charAt(0) === '#') { i++; continue; }
    var idx = trimmed.indexOf(':');
    if (idx === -1) { i++; continue; }
    var key = trimmed.slice(0, idx).trim();
    var val = trimmed.slice(idx + 1).trim();
    // Detect a list value (next lines are indented "- ...")
    if (!val) {
      var listItems = [];
      i++;
      while (i < lines.length) {
        var itemLine = lines[i];
        var itemTrimmed = itemLine.trim();
        if (!itemTrimmed || itemTrimmed.charAt(0) === '#') { i++; continue; }
        // Stop if non-indented non-list line (top-level key)
        var indent = itemLine.search(/\S/);
        if (indent === 0) break;
        if (itemTrimmed.charAt(0) === '-') {
          // Parse inline map: "- port: 80\n    name: http" or "- port: 80, name: http"
          var itemVal = itemTrimmed.slice(1).trim();
          var itemObj = {};
          // Check subsequent lines with greater indent for same map item
          var baseIndent = indent;
          var pairs = [itemVal];
          i++;
          while (i < lines.length) {
            var nextLine = lines[i];
            var nextTrimmed = nextLine.trim();
            if (!nextTrimmed) { i++; continue; }
            var nextIndent = nextLine.search(/\S/);
            if (nextIndent <= baseIndent) break;
            pairs.push(nextTrimmed);
            i++;
          }
          pairs.forEach(function(pair) {
            if (!pair) return;
            var pi = pair.indexOf(':');
            if (pi === -1) return;
            var pk = pair.slice(0, pi).trim();
            var pv = pair.slice(pi + 1).trim();
            if (/^\d+$/.test(pv)) pv = parseInt(pv, 10);
            itemObj[pk] = pv;
          });
          listItems.push(itemObj);
        } else {
          i++;
        }
      }
      result[key] = listItems;
      continue;
    }
    if (/^\d+$/.test(val)) val = parseInt(val, 10);
    else if (val === 'true') val = true;
    else if (val === 'false') val = false;
    result[key] = val;
    i++;
  }
  return result;
}

function objToYaml(obj) {
  if (!obj || typeof obj !== 'object') return String(obj || '');
  return Object.keys(obj).map(function(k) {
    var v = obj[k];
    if (Array.isArray(v)) {
      if (!v.length) return k + ': []';
      return k + ':\n' + v.map(function(item) {
        if (typeof item === 'object' && item !== null) {
          var pairs = Object.keys(item).map(function(ik) { return '    ' + ik + ': ' + item[ik]; });
          return '  - ' + pairs[0].trim() + (pairs.length > 1 ? '\n' + pairs.slice(1).join('\n') : '');
        }
        return '  - ' + item;
      }).join('\n');
    }
    return k + ': ' + v;
  }).join('\n');
}

// ════════════════════════════════════════════════════════════
//  YAML editor
// ════════════════════════════════════════════════════════════

var _YAML_PLACEHOLDER = [
  '# required',
  'image: nginx:latest',
  '',
  '# ports',
  'ports:',
  '  - port: 80',
  '    name: http',
  '',
  '# scaling',
  'replicas: 1',
  '',
  '# resources (optional)',
  '# cpu: 0.5',
  '# memory_mb: 256',
].join('\n');

var _YAML_BLANK = 'image: nginx:latest\nreplicas: 1\nports:\n  - port: 80\n    name: http';

function _yamlHighlight(text, isPlaceholder) {
  var lines = text.split('\n');
  return lines.map(function(line) {
    if (isPlaceholder) return '<span class="yph">' + _he(line) + '</span>';
    // comment line
    if (/^\s*#/.test(line)) return '<span class="yc">' + _he(line) + '</span>';
    // key: value
    var m = line.match(/^(\s*)(- )?([^:#\n]+?)(\s*:\s*)(.*)$/);
    if (m) {
      var indent = _he(m[1]);
      var dash   = m[2] ? '<span class="yli">- </span>' : '';
      var key    = '<span class="yk">' + _he(m[3]) + '</span>';
      var colon  = _he(m[4]);
      var val    = m[5];
      var valHtml;
      if (!val || val === '') {
        valHtml = '';
      } else if (/^#/.test(val.trim())) {
        valHtml = '<span class="yc">' + _he(val) + '</span>';
      } else if (/^(true|false)$/.test(val.trim())) {
        valHtml = '<span class="ybool">' + _he(val) + '</span>';
      } else if (/^-?\d+(\.\d+)?$/.test(val.trim())) {
        valHtml = '<span class="yn">' + _he(val) + '</span>';
      } else {
        // string — split trailing inline comment
        var ci = val.indexOf('  #');
        if (ci !== -1) {
          valHtml = '<span class="ys">' + _he(val.slice(0, ci)) + '</span>'
                  + '<span class="yc">' + _he(val.slice(ci)) + '</span>';
        } else {
          valHtml = '<span class="ys">' + _he(val) + '</span>';
        }
      }
      return indent + dash + key + colon + valHtml;
    }
    // bare list item (- value)
    var lm = line.match(/^(\s*)-\s+(.*)$/);
    if (lm) return _he(lm[1]) + '<span class="yli">- </span><span class="ys">' + _he(lm[2]) + '</span>';
    return _he(line);
  }).join('\n');
}

function _he(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function _initYamlEditor(wrapId, taId, hlId, linenosId) {
  var wrap    = document.getElementById(wrapId);
  var ta      = document.getElementById(taId);
  var hl      = document.getElementById(hlId);
  var lnos    = document.getElementById(linenosId);
  var isPlaceholder = true;

  function update() {
    var text = ta.value;
    var lines = text.split('\n').length;
    var nums = [];
    for (var i = 1; i <= lines; i++) nums.push(i);
    lnos.textContent = nums.join('\n');
    hl.innerHTML = _yamlHighlight(text, isPlaceholder) + '\n'; // trailing \n keeps last line height
  }

  function setPlaceholder() {
    isPlaceholder = true;
    ta.value = _YAML_PLACEHOLDER;
    wrap.classList.add('is-placeholder');
    update();
  }

  function clearPlaceholder() {
    if (!isPlaceholder) return;
    isPlaceholder = false;
    ta.value = '';
    wrap.classList.remove('is-placeholder');
    update();
  }

  ta.addEventListener('focus', clearPlaceholder);

  ta.addEventListener('blur', function() {
    if (!ta.value.trim()) setPlaceholder();
  });

  ta.addEventListener('input', function() {
    if (isPlaceholder) { isPlaceholder = false; wrap.classList.remove('is-placeholder'); }
    update();
  });

  // Tab → 2 spaces
  ta.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      var s = ta.selectionStart, end = ta.selectionEnd;
      ta.value = ta.value.slice(0, s) + '  ' + ta.value.slice(end);
      ta.selectionStart = ta.selectionEnd = s + 2;
      update();
    }
  });

  // Sync highlight scroll with textarea scroll
  ta.addEventListener('scroll', function() { hl.scrollTop = ta.scrollTop; });

  setPlaceholder();

  // Expose a getter for the real spec value (returns '' when placeholder)
  return {
    getValue: function() { return isPlaceholder ? '' : ta.value; },
    setValue: function(text) {
      isPlaceholder = false;
      ta.value = text;
      wrap.classList.remove('is-placeholder');
      update();
    },
    reset: function() { setPlaceholder(); },
  };
}

var _deployEditor;

// ════════════════════════════════════════════════════════════
//  Render: Inbound requests
// ════════════════════════════════════════════════════════════

function renderInbound(list) {
  var banner = document.getElementById('inbound-banner');
  var listEl = document.getElementById('inbound-list');
  var badge  = document.getElementById('nav-inbound-badge');

  if (!list.length) {
    banner.classList.remove('visible');
    badge.style.display = 'none';
    return;
  }

  banner.classList.add('visible');
  badge.style.display = '';
  badge.textContent = list.length;

  listEl.innerHTML = list.map(function(r) {
    var id   = r.id;
    var name = r.name.replace(/'/g, "\\'");
    return '<div class="inbound-item">'
      + '<div class="inbound-item-info">'
      + '<div class="inbound-item-name">' + r.name + '</div>'
      + '<div class="inbound-item-url">' + (r.url || '') + '</div>'
      + '</div>'
      + '<div class="inbound-item-time">' + timeAgo(r.since) + '</div>'
      + '<div class="btn-row">'
      + '<button class="btn-sm btn-success" onclick="acceptInbound(\'' + id + '\', \'' + name + '\')">Accept</button>'
      + '<button class="btn-sm btn-danger"  onclick="rejectInbound(\'' + id + '\', \'' + name + '\')">Reject</button>'
      + '</div>'
      + '</div>';
  }).join('');
}

async function acceptInbound(id, name) {
  var r = await fetch('/peers/inbound/' + id + '/accept', { method: 'POST' });
  var d = await r.json();
  if (r.ok) toast('Connected to ' + name, 'ok');
  else toast('Failed: ' + (d.error || r.statusText), 'error');
  refresh();
}

async function rejectInbound(id, name) {
  var r = await fetch('/peers/inbound/' + id, { method: 'DELETE' });
  if (r.ok) toast('Rejected request from ' + name);
  else toast('Error rejecting request', 'error');
  refresh();
}

// ════════════════════════════════════════════════════════════
//  Render: Peers
// ════════════════════════════════════════════════════════════

function renderOverviewPeers(peers) {
  var body  = document.getElementById('overview-peers-body');
  var empty = document.getElementById('overview-peers-empty');
  var badge = document.getElementById('peers-count-badge');

  var connected = peers.filter(function(p) { return !p.status || p.status === 'connected'; });
  badge.textContent = connected.length;

  if (!connected.length) { body.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';
  body.innerHTML = connected.map(function(p) {
    return '<tr>'
      + '<td><strong>' + p.name + '</strong></td>'
      + '<td class="mono">' + (p.url || '') + '</td>'
      + '<td class="time-ago">' + timeAgo(p.connected_at) + '</td>'
      + '</tr>';
  }).join('');
}

function renderAllPeers(peers) {
  var body  = document.getElementById('all-peers-body');
  var empty = document.getElementById('all-peers-empty');
  var count = document.getElementById('all-peers-count');
  count.textContent = peers.length;
  if (!peers.length) { body.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  body.innerHTML = peers.map(function(p) {
    var isConn  = p.status === 'connecting';
    var isAwait = p.status === 'awaiting_confirmation';
    var isFail  = p.status === 'failed';
    var isPend  = isConn || isAwait || isFail;

    var statusCell = isPend
      ? (isConn  ? '<span class="badge badge-connecting">connecting</span>'
      : isAwait  ? '<span class="badge badge-handshake">awaiting</span>'
      : '<span class="badge badge-failed">failed</span>')
      : '<span class="badge badge-mtls"><span class="badge-dot"></span>mTLS</span>';

    var actionBtn = '';
    if (isConn || isAwait) {
      actionBtn = '<button class="btn-sm btn-danger peer-cancel-btn">Cancel</button>';
    } else if (isFail) {
      actionBtn = '<span class="btn-row">'
        + '<button class="btn-sm peer-retry-btn">Retry</button>'
        + '<button class="btn-sm btn-danger peer-cancel-btn">Dismiss</button>'
        + '</span>';
    } else {
      actionBtn = '<button class="btn-sm btn-danger peer-remove-btn">Remove</button>';
    }

    return '<tr data-peer-url="' + _esc(p.url) + '" data-peer-name="' + _esc(p.name) + '">'
      + '<td><strong>' + _esc(p.name) + '</strong>'
      + (isConn ? ' <span class="text-muted text-sm">attempt ' + (p.attempts||1) + '</span>' : '')
      + '</td>'
      + '<td class="mono">' + _esc(p.url || '') + '</td>'
      + '<td>' + statusCell + '</td>'
      + '<td class="time-ago">' + timeAgo(p.connected_at) + '</td>'
      + '<td>' + actionBtn + '</td>'
      + '</tr>';
  }).join('');
}

async function removePeer(name) {
  var ok = await showConfirm('Remove peer "' + name + '"?', 'This only removes the peer locally. The remote agent is unaffected.', 'Remove');
  if (!ok) return;
  var r = await fetch('/peers/' + name, { method: 'DELETE' });
  var d = await r.json();
  if (r.ok) toast('Removed ' + name, 'ok');
  else toast('Error: ' + d.error, 'error');
  refresh();
}

async function cancelConnecting(url) {
  var r = await fetch('/peers/connecting?url=' + encodeURIComponent(url), { method: 'DELETE' });
  var d = await r.json();
  if (r.ok) toast('Cancelled', 'ok');
  else toast('Error: ' + d.error, 'error');
  refresh();
}

async function retryConnecting(url) {
  var token = await showPrompt('Retry connection', 'Enter the invite token for:\n' + url, 'Invite token…');
  if (!token || !token.trim()) return;
  var r = await fetch('/peers/retry', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({url: url, invite_token: token.trim()}),
  });
  var d = await r.json();
  if (r.ok) toast('Retrying…', 'ok');
  else toast('Error: ' + (d.error || 'retry failed'), 'error');
  refresh();
}

// ════════════════════════════════════════════════════════════
//  Render: Apps
// ════════════════════════════════════════════════════════════

function renderApps(list, bodyId, emptyId, countId, showSource) {
  var body  = document.getElementById(bodyId);
  var empty = document.getElementById(emptyId);
  if (countId) document.getElementById(countId).textContent = list.length;
  if (!list.length) { body.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  body.innerHTML = list.map(function(a) {
    var isDead = a.status === 'Deleted' || a.status === 'Failed' || a.status === 'Timeout';
    // submitted apps show target_peer (where it runs); executing apps show source_peer (who sent it)
    var peerVal = showSource ? (a.source_peer || '—') : (a.target_peer || '—');
    var peerCell = '<td class="text-muted text-sm">' + _esc(peerVal) + '</td>';
    return '<tr' + (isDead ? ' style="opacity:0.55;"' : '') + ' data-app-id="' + _esc(a.id) + '" data-app-name="' + _esc(a.name) + '">'
      + '<td><a href="#" class="app-open-link" style="color:var(--accent2);text-decoration:none;font-weight:500;">' + _esc(a.name) + '</a></td>'
      + '<td class="mono">' + _esc(a.id) + '</td>'
      + '<td>' + statusBadge(a.status) + '</td>'
      + peerCell
      + '<td class="time-ago">' + timeAgo(a.updated_at) + '</td>'
      + '<td><span class="btn-row">'
      + '<button class="btn-sm app-detail-btn">Detail</button>'
      + '<button class="btn-sm btn-danger app-delete-btn">Delete</button>'
      + '</span></td>'
      + '</tr>';
  }).join('');
}

function renderRecentApps(submitted, executing) {
  var all = submitted.map(function(a) { return Object.assign({}, a, {_type:'submitted'}); })
    .concat(executing.map(function(a) { return Object.assign({}, a, {_type:'executing'}); }));
  all.sort(function(a,b) { return new Date(b.updated_at) - new Date(a.updated_at); });
  all = all.slice(0, 8);

  var body  = document.getElementById('recent-apps-body');
  var empty = document.getElementById('recent-apps-empty');
  var count = document.getElementById('recent-apps-count');
  count.textContent = all.length;

  if (!all.length) { body.innerHTML = ''; empty.style.display = ''; return; }
  empty.style.display = 'none';

  body.innerHTML = all.map(function(a) {
    var typeLabel = a._type === 'submitted'
      ? '<span class="badge badge-handshake" style="font-size:0.65rem;">outbound</span>'
      : '<span class="badge badge-inbound"   style="font-size:0.65rem;">inbound</span>';
    return '<tr data-app-id="' + _esc(a.id) + '" data-app-name="' + _esc(a.name) + '">'
      + '<td><a href="#" class="app-open-link" style="color:var(--accent2);text-decoration:none;font-weight:500;">' + _esc(a.name) + '</a></td>'
      + '<td>' + typeLabel + '</td>'
      + '<td>' + statusBadge(a.status) + '</td>'
      + '<td class="time-ago">' + timeAgo(a.updated_at) + '</td>'
      + '<td><span class="btn-row">'
      + '<button class="btn-sm app-detail-btn">Detail</button>'
      + '<button class="btn-sm btn-danger app-delete-btn">Delete</button>'
      + '</span></td>'
      + '</tr>';
  }).join('');
}

async function deleteApp(id, name) {
  var ok = await showConfirm('Delete "' + name + '"?', 'This removes the Kubernetes Deployment on the peer cluster. This cannot be undone.', 'Delete');
  if (!ok) return;
  var r = await fetch('/remoteapp/' + id, { method: 'DELETE' });
  var d = await r.json();
  if (r.ok) {
    toast('Deleted ' + name, 'ok');
    closeAppModal();
    refresh();
  } else {
    toast('Error: ' + (d.error || 'delete failed'), 'error');
  }
}

// ════════════════════════════════════════════════════════════
//  Render: Proxy page (submitted apps + their proxy URLs)
// ════════════════════════════════════════════════════════════

function renderProxyApps(submitted) {
  var el = document.getElementById('proxy-apps-list');
  if (!el) return;
  var active = submitted.filter(function(a) {
    return a.status !== 'Deleted' && a.status !== 'Failed' && a.status !== 'Timeout';
  });
  if (!active.length) {
    el.innerHTML = '<div class="empty-state" style="padding:1.5rem 0.5rem;"><div class="empty-icon">⇒</div>No submitted apps yet</div>';
    return;
  }
  el.innerHTML = active.map(function(a) {
    var ports = (a.spec && Array.isArray(a.spec.ports) && a.spec.ports.length)
      ? a.spec.ports
      : [{ port: (a.spec && a.spec.port) || 80 }];
    var portLinks = ports.map(function(p) {
      var portNum = typeof p === 'object' ? (p.port || 80) : p;
      var portLabel = (p.name ? p.name + ' (' + portNum + ')' : portNum);
      var proxyUrl = window.location.origin + '/remoteapp/' + _esc(a.id) + '/proxy/' + portNum;
      var btnId = 'proxy-page-' + _esc(a.id) + '-' + portNum;
      return '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0;border-bottom:1px solid var(--border);">'
        + '<span class="mono" style="color:var(--muted);min-width:60px;font-size:0.75rem;">' + portLabel + '</span>'
        + '<span class="mono" id="' + btnId + '" style="flex:1;font-size:0.72rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--accent2);" title="' + _esc(proxyUrl) + '">' + _esc(proxyUrl) + '</span>'
        + '<button class="btn-sm" style="padding:1px 7px;font-size:0.7rem;flex-shrink:0;" onclick="copyText(\'' + btnId + '\', this)">Copy</button>'
        + '</div>';
    }).join('');
    return '<div style="padding:0.75rem 0;border-bottom:1px solid var(--border);">'
      + '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">'
      + '<strong style="font-size:0.845rem;">' + _esc(a.name) + '</strong>'
      + statusBadge(a.status)
      + '<span class="text-muted text-sm" style="margin-left:auto;">' + _esc(a.target_peer || '') + '</span>'
      + '</div>'
      + portLinks
      + '</div>';
  }).join('');
}

// ════════════════════════════════════════════════════════════
//  Main refresh
// ════════════════════════════════════════════════════════════

async function refresh() {
  try {
    var [peersR, appsR, inboundR] = await Promise.all([
      fetch('/peers'),
      fetch('/remoteapps'),
      fetch('/peers/inbound'),
    ]);

    var peers   = await peersR.json();
    var apps    = await appsR.json();
    var inbound = await inboundR.json();

    var submitted = apps.submitted || [];
    var executing = apps.executing || [];

    // Stats
    var connected = peers.filter(function(p) { return !p.status || (p.status !== 'connecting' && p.status !== 'awaiting_confirmation' && p.status !== 'failed'); });
    document.getElementById('stat-peers').textContent     = connected.length;
    document.getElementById('stat-submitted').textContent = submitted.length;
    document.getElementById('stat-executing').textContent = executing.length;

    var connecting = peers.filter(function(p) { return p.status === 'connecting'; }).length;
    var awaiting   = peers.filter(function(p) { return p.status === 'awaiting_confirmation'; }).length;
    var sub = [];
    if (connecting) sub.push(connecting + ' connecting');
    if (awaiting)   sub.push(awaiting + ' awaiting');
    document.getElementById('stat-peers-sub').textContent = sub.length ? sub.join(', ') : (connected.length ? 'all connected' : 'no peers');

    var peerLabel = connected.length + ' peer' + (connected.length !== 1 ? 's' : '');
    if (connecting) peerLabel += ', ' + connecting + ' connecting';
    if (awaiting)   peerLabel += ', ' + awaiting + ' waiting';
    document.getElementById('peer-count-label').textContent = peerLabel;

    // Render
    renderOverviewPeers(peers);
    renderAllPeers(peers);
    renderInbound(inbound);
    renderRecentApps(submitted, executing);
    renderApps(submitted, 'submitted-body', 'submitted-empty', 'submitted-count', false);
    renderApps(executing, 'executing-body', 'executing-empty', 'executing-count', true);
    renderProxyApps(submitted);

    document.getElementById('health-dot').className = 'health-dot';
    document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
  } catch (err) {
    document.getElementById('health-dot').className = 'health-dot red';
  }
}

// ════════════════════════════════════════════════════════════
//  Deploy form
// ════════════════════════════════════════════════════════════

document.getElementById('deploy-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  var name = document.getElementById('app-name').value.trim();
  var yaml = _deployEditor ? _deployEditor.getValue() : document.getElementById('app-spec-yaml').value;
  if (!name) return;
  if (!yaml.trim()) { toast('Spec cannot be empty', 'error'); return; }
  var spec;
  try { spec = parseSimpleYaml(yaml); }
  catch(err) { toast('Invalid YAML: ' + err.message, 'error'); return; }
  var r = await fetch('/remoteapp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name, spec: spec }),
  });
  var d = await r.json();
  if (r.ok) {
    toast('Deployed ' + name, 'ok');
    document.getElementById('app-name').value = '';
    if (_deployEditor) _deployEditor.reset(); else document.getElementById('app-spec-yaml').value = _YAML_BLANK;
    setTimeout(refresh, 500);
  } else if (d.inbound_disabled) {
    toast('Remote agent has inbound workloads disabled — enable it in the peer\'s Settings', 'warn');
  } else {
    toast('Error: ' + (d.error || r.statusText), 'error');
  }
});

// ════════════════════════════════════════════════════════════
//  Connect peer form
// ════════════════════════════════════════════════════════════

document.getElementById('connect-peer-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  var url   = document.getElementById('new-peer-url').value.trim();
  var token = document.getElementById('new-peer-token').value.trim();
  var fp    = document.getElementById('new-peer-fp').value.trim();
  if (!url)   { toast('Peer URL is required', 'error'); return; }
  if (!token) { toast('Invite token is required', 'error'); return; }
  if (!fp)    { toast('CA fingerprint is required', 'error'); return; }
  var r = await fetch('/peers/connect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url: url, invite_token: token, ca_fingerprint: fp }),
  });
  var d = await r.json();
  if (r.ok) {
    toast(d.message || 'Peering initiated', 'ok');
    document.getElementById('new-peer-url').value   = '';
    document.getElementById('new-peer-token').value = '';
    document.getElementById('new-peer-fp').value    = '';
    setTimeout(refresh, 500);
  } else {
    toast('Error: ' + (d.error || r.statusText), 'error');
  }
});

// ════════════════════════════════════════════════════════════
//  Settings
// ════════════════════════════════════════════════════════════

function setSegVal(ctrlId, activeBtn) {
  document.getElementById(ctrlId).querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
  activeBtn.classList.add('active');
}
function getSegVal(ctrlId) {
  var active = document.getElementById(ctrlId).querySelector('button.active');
  return active ? active.dataset.val : '';
}
function applySegVal(ctrlId, val) {
  document.getElementById(ctrlId).querySelectorAll('button').forEach(function(b) {
    b.classList.toggle('active', b.dataset.val === val);
  });
}

async function loadSettings() {
  try {
    var r = await fetch('/settings');
    var s = await r.json();
    applySegVal('setting-log-level', s.log_level || 'INFO');
    document.getElementById('setting-inbound-apps').checked = !!s.allow_inbound_remoteapps;
    document.getElementById('quota-cpu-pod').value        = s.max_cpu_per_pod || 0;
    document.getElementById('quota-mem-pod').value        = s.max_memory_mb_per_pod || 0;
    document.getElementById('quota-replicas').value       = s.max_replicas_per_app || 0;
    document.getElementById('quota-total-deploys').value  = s.max_total_deployments || 0;
    document.getElementById('quota-total-cpu').value      = s.max_total_cpu || 0;
    document.getElementById('quota-total-mem').value      = s.max_total_memory_mb || 0;
  } catch(e) {}
}

async function saveQuotas() {
  var body = {
    max_cpu_per_pod:       parseFloat(document.getElementById('quota-cpu-pod').value)       || 0,
    max_memory_mb_per_pod: parseInt(document.getElementById('quota-mem-pod').value, 10)     || 0,
    max_replicas_per_app:  parseInt(document.getElementById('quota-replicas').value, 10)    || 0,
    max_total_deployments: parseInt(document.getElementById('quota-total-deploys').value,10) || 0,
    max_total_cpu:         parseFloat(document.getElementById('quota-total-cpu').value)      || 0,
    max_total_memory_mb:   parseInt(document.getElementById('quota-total-mem').value, 10)   || 0,
  };
  var r = await fetch('/settings', {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
  });
  if (r.ok) toast('Quotas saved', 'ok');
  else { var d = await r.json(); toast('Error: ' + d.error, 'error'); }
}

async function loadToken() {
  try {
    var r = await fetch('/token');
    var d = await r.json();
    var url = d.self_url || '(not set)';
    var token = d.invite_token || '';
    var fp    = d.cert_fingerprint || '';
    // Peers page — masked secrets
    setSecret('token-key', token);
    setSecret('token-fp-peers', fp);
    document.getElementById('token-url').textContent = url;
    // Settings page — masked secrets
    setSecret('settings-token-key', token);
    setSecret('token-fp', fp);
    document.getElementById('settings-token-url').textContent = url;
    document.getElementById('token-pem').value = d.ca_pem || '';
    document.getElementById('about-url').textContent = url;
  } catch(e) {}
}

function setSecret(id, value) {
  var el = document.getElementById(id);
  if (!el) return;
  el.dataset.value = value;
  // Keep masked if already masked, reveal if already revealed
  if (!el.classList.contains('masked')) {
    el.textContent = value || '—';
  }
}

var _EYE_SHOW = '<svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/><circle cx="10" cy="10" r="2.5"/></svg>';
var _EYE_HIDE = '<svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/><circle cx="10" cy="10" r="2.5"/><line x1="2" y1="2" x2="18" y2="18"/></svg>';

function toggleSecret(id, btn) {
  var el = document.getElementById(id);
  if (!el) return;
  var masked = el.classList.contains('masked');
  if (masked) {
    el.classList.remove('masked');
    el.textContent = el.dataset.value || '—';
    btn.innerHTML = _EYE_HIDE;
  } else {
    el.classList.add('masked');
    el.textContent = '••••••••••••••••••••••••••••••••';
    btn.innerHTML = _EYE_SHOW;
  }
}

function copySecret(id, btn) {
  var el = document.getElementById(id);
  if (!el) return;
  var val = el.dataset.value || el.textContent;
  navigator.clipboard.writeText(val).then(function() {
    var orig = btn.textContent;
    btn.textContent = '✓';
    setTimeout(function() { btn.textContent = orig; }, 1200);
  });
}

async function saveSetting(key, value) {
  var body = {}; body[key] = value;
  var r = await fetch('/settings', {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
  });
  if (r.ok) toast('Saved', 'ok');
  else { var d = await r.json(); toast('Error: ' + d.error, 'error'); }
}


// ════════════════════════════════════════════════════════════
//  App detail modal
// ════════════════════════════════════════════════════════════

var _currentAppId = null;

async function openAppModal(appId) {
  _currentAppId = appId;
  document.getElementById('app-modal-title').textContent = 'App Detail';
  document.getElementById('app-modal-body').innerHTML = '<p class="text-muted text-sm">Loading…</p>';
  document.getElementById('app-modal').classList.add('open');
  await refreshAppModal();
}

function closeAppModal() {
  document.getElementById('app-modal').classList.remove('open');
  _currentAppId = null;
}

document.getElementById('app-modal').addEventListener('click', function(e) {
  if (e.target === this) closeAppModal();
});

async function refreshAppModal() {
  if (!_currentAppId) return;
  try {
    var r = await fetch('/remoteapp/' + _currentAppId + '/detail');
    if (!r.ok) { document.getElementById('app-modal-body').innerHTML = '<p style="color:var(--red)">Failed to load.</p>'; return; }
    renderAppDetail(await r.json());
  } catch(e) {
    document.getElementById('app-modal-body').innerHTML = '<p style="color:var(--red)">Error: ' + e.message + '</p>';
  }
}

function renderAppDetail(d) {
  var app = d.app || {};
  var k8s = d.k8s || {};
  document.getElementById('app-modal-title').textContent = (app.name || 'App') + ' — Detail';
  var spec = app.spec || {};
  var pods = k8s.pods || [];

  var html = '<div class="detail-grid">';
  var peerRow = app.target_peer
    ? '<div class="detail-row"><span class="label">Running on</span><span>' + app.target_peer + '</span></div>'
    : (app.source_peer ? '<div class="detail-row"><span class="label">From peer</span><span>' + app.source_peer + '</span></div>' : '');
  // Build app-ID row with inline copy button
  var idVal = app.id || '—';
  var idRow = '<div class="detail-row"><span class="label">ID</span>'
    + '<span style="display:flex;align-items:center;gap:0.4rem;">'
    + '<span class="mono" id="modal-app-id">' + _esc(idVal) + '</span>'
    + '<button class="btn-sm" style="padding:1px 7px;font-size:0.7rem;" onclick="copyText(\'modal-app-id\', this)">Copy</button>'
    + '</span></div>';

  html += '<div class="detail-block"><h4>App Info</h4>'
    + idRow
    + '<div class="detail-row"><span class="label">Status</span>' + statusBadge(app.status) + '</div>'
    + peerRow
    + '<div class="detail-row"><span class="label">Created</span><span class="time-ago">' + timeAgo(app.created_at) + '</span></div>'
    + '<div class="detail-row"><span class="label">Updated</span><span class="time-ago">' + timeAgo(app.updated_at) + '</span></div>'
    + '</div>';

  // Build ports rows — supports new ports list or legacy port scalar
  var portsHtml = '';
  var specPorts = spec.ports;
  if (Array.isArray(specPorts) && specPorts.length) {
    // Proxy base: the submitting agent's own URL (same origin as dashboard)
    var proxyBase = window.location.origin + '/remoteapp/' + _esc(idVal) + '/proxy';
    portsHtml = specPorts.map(function(p) {
      var portNum = p.port || p;
      var portName = p.name ? ' (' + p.name + ')' : '';
      var proxyUrl = proxyBase + '/' + portNum;
      var proxyId = 'proxy-url-' + portNum;
      return '<div class="detail-row"><span class="label">' + portNum + portName + '</span>'
        + '<span style="display:flex;align-items:center;gap:0.4rem;min-width:0;">'
        + '<span class="mono" id="' + proxyId + '" style="font-size:0.72rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:260px;" title="' + _esc(proxyUrl) + '">' + _esc(proxyUrl) + '</span>'
        + '<button class="btn-sm" style="padding:1px 7px;font-size:0.7rem;flex-shrink:0;" onclick="copyText(\'' + proxyId + '\', this)">Copy</button>'
        + '</span></div>';
    }).join('');
  } else {
    var legacyPort = spec.port || 80;
    portsHtml = '<div class="detail-row"><span class="label">Port</span><span>' + legacyPort + '</span></div>';
  }

  html += '<div class="detail-block"><h4>Spec</h4>'
    + '<div class="detail-row"><span class="label">Image</span><span class="mono">' + (spec.image||'—') + '</span></div>'
    + '<div class="detail-row"><span class="label">Replicas</span><span>' + (spec.replicas||1) + '</span></div>'
    + '<div class="detail-row"><span class="label">CPU</span><span>' + (spec.cpu ? spec.cpu+' cores':'—') + '</span></div>'
    + '<div class="detail-row"><span class="label">Memory</span><span>' + (spec.memory_mb ? spec.memory_mb+' MiB':'—') + '</span></div>'
    + portsHtml
    + '</div>';
  html += '</div>';

  if (k8s.error) {
    html += '<p class="text-muted text-sm" style="margin-top:0.75rem;">' + k8s.error + '</p>';
  } else if (k8s.desired !== undefined) {
    html += '<div class="detail-block" style="margin-top:0.75rem;"><h4>Kubernetes</h4>'
      + '<div class="detail-row"><span class="label">Desired</span><span>' + k8s.desired + '</span></div>'
      + '<div class="detail-row"><span class="label">Ready</span><span>' + k8s.ready + ' / ' + k8s.desired + '</span></div>'
      + '<div class="detail-row"><span class="label">Available</span><span>' + k8s.available + '</span></div>'
      + '</div>';
    if (pods.length) {
      html += '<div style="margin-top:0.75rem;overflow:auto;"><table class="pod-table">'
        + '<thead><tr><th>Pod</th><th>Phase</th><th>Ready</th><th>Restarts</th><th>Node</th></tr></thead><tbody>'
        + pods.map(function(p) {
          return '<tr>'
            + '<td class="mono">' + (p.name||'—') + '</td>'
            + '<td>' + statusBadge(p.phase) + '</td>'
            + '<td>' + (p.ready ? '<span style="color:var(--green)">✓</span>' : '<span style="color:var(--red)">✗</span>') + '</td>'
            + '<td>' + (p.restarts||0) + '</td>'
            + '<td class="mono">' + (p.node||'—') + '</td>'
            + '</tr>';
        }).join('')
        + '</tbody></table></div>';
    }
  }

  html += '<div class="detail-block" style="margin-top:0.75rem;"><h4>Edit Spec (YAML)</h4>'
    + '<textarea id="app-spec-editor" style="width:100%;height:110px;background:var(--bg);color:var(--text);border:1px solid var(--border2);border-radius:6px;padding:0.5rem;font-family:monospace;font-size:0.8rem;resize:vertical;">'
    + objToYaml(spec) + '</textarea></div>';

  html += '<div class="detail-actions">'
    + '<label>Scale:</label>'
    + '<input type="text" inputmode="numeric" id="scale-replicas-input" value="' + (spec.replicas||1) + '" style="width:65px;">'
    + '<button class="btn-sm btn-success" id="modal-scale-btn">Scale</button>'
    + '<button class="btn-sm" id="modal-spec-btn" style="margin-left:auto;">Apply Spec</button>'
    + '<button class="btn-sm btn-danger" id="modal-delete-btn">Delete</button>'
    + '</div>';

  document.getElementById('app-modal-body').innerHTML = html;

  // Wire modal action buttons after innerHTML is set (avoids inline onclick quoting issues)
  var _id   = _currentAppId;
  var _name = app.name || '';
  document.getElementById('modal-scale-btn').addEventListener('click', function() { scaleApp(_id); });
  document.getElementById('modal-spec-btn').addEventListener('click', function() { updateAppSpec(_id); });
  document.getElementById('modal-delete-btn').addEventListener('click', function() { deleteApp(_id, _name); });
}

async function scaleApp(id) {
  var replicas = parseInt(document.getElementById('scale-replicas-input').value, 10);
  if (isNaN(replicas) || replicas < 0) { toast('Invalid replica count', 'error'); return; }
  var r = await fetch('/remoteapp/' + id + '/scale', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ replicas: replicas }),
  });
  var d = await r.json();
  if (r.ok) { toast('Scaled to ' + d.replicas, 'ok'); await refreshAppModal(); refresh(); }
  else toast('Scale error: ' + (d.error||'unknown'), 'error');
}

async function updateAppSpec(id) {
  var yaml = document.getElementById('app-spec-editor').value;
  var spec;
  try { spec = parseSimpleYaml(yaml); } catch(e) { toast('Invalid YAML', 'error'); return; }
  var r = await fetch('/remoteapp/' + id + '/spec', {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ spec: spec }),
  });
  var d = await r.json();
  if (r.ok) { toast('Spec updated — redeploying…', 'ok'); await refreshAppModal(); refresh(); }
  else toast('Error: ' + (d.error||'update failed'), 'error');
}

// ════════════════════════════════════════════════════════════
//  Boot
// ════════════════════════════════════════════════════════════

_deployEditor = _initYamlEditor('deploy-editor-wrap', 'app-spec-yaml', 'deploy-editor-hl', 'deploy-editor-linenos');
refresh();
loadSettings();
loadToken();
setInterval(refresh, 3000);
setInterval(loadToken, 5000);
</script>
</body>
</html>
